<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ì¶”ì²œí•´ë“œë¦¬ë°</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="screen chat-screen">

    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="chat-header">
      <a href="home.html" class="back">â€¹</a>
      <h1 class="chat-title">ì¶”ì²œí•´ë“œë¦¬ë°</h1>
    </header>

    <!-- ì±„íŒ… ì˜ì—­ -->
    <main class="chat-body" id="chat-body">
      <div class="chat-row bot">
        <div class="chat-bubble">
          ì•ˆë…•í•˜ì„¸ìš”! ğŸ˜Š ì €ëŠ” ë“œë¦¼ìš”ì˜ AI ì±—ë´‡<br />
          <b>ì¶”ì²œí•´ë“œë¦¬ë°</b> ì…ë‹ˆë‹¤.<br /><br />
          ë³´ìœ  í¬ì¸íŠ¸(ë§ˆì¼ë¦¬ì§€)ë¥¼ ì…ë ¥í•˜ë©´<br />
          ê¸°ë¶€ ê°€ëŠ¥í•œ ë©”ë‰´ë¥¼ ì¶”ì²œí•´ë“œë¦´ê²Œìš”!<br />
          ì˜ˆ: 5000
        </div>
      </div>
    </main>

    <!-- ì…ë ¥ì°½ -->
    <form class="chat-input-bar" id="chat-form">
      <input
        type="text"
        id="chat-input"
        class="chat-input"
        placeholder="ë³´ìœ  í¬ì¸íŠ¸ ì…ë ¥ (ì˜ˆ: 5000)"
        autocomplete="off"
      />
      <button type="submit" class="chat-send-button">ì „ì†¡</button>
    </form>
  </div>

  <script src="./pwa.js"></script>

  <!-- ================= SCRIPT ================= -->
  <script type="module">
    /* ================= Gemini API ================= */
    const GEMINI_API_KEY = "ì—¬ê¸°ì—_ë„ˆì˜_GEMINI_API_KEY";

    /* ================= Firebase ================= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      limit,
      collectionGroup
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBo1Ezg6tzCDDCGpBNWmJfCLe8hUsmLYi4",
      authDomain: "dreamyo-e42bb.firebaseapp.com",
      projectId: "dreamyo-e42bb",
      storageBucket: "dreamyo-e42bb.firebasestorage.app",
      messagingSenderId: "266927967076",
      appId: "1:266927967076:web:e5aca8599bc776b0774871"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ================= DOM ================= */
    const chatBody = document.getElementById("chat-body");
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");

    let menus = [];
    let selectedItem = null;
    let actionsShown = false;

    /* ================= UI ================= */
    function addBubble(text, type) {
      const row = document.createElement("div");
      row.className = "chat-row " + type;
      const bubble = document.createElement("div");
      bubble.className = "chat-bubble";
      bubble.innerHTML = text.replace(/\n/g, "<br>");
      row.appendChild(bubble);
      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function addCardBubble(html) {
      const row = document.createElement("div");
      row.className = "chat-row bot";
      const bubble = document.createElement("div");
      bubble.className = "chat-bubble chat-bubble-card";
      bubble.innerHTML = html;
      row.appendChild(bubble);
      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function clearActions() {
      document.querySelector(".chat-options")?.remove();
      document.querySelector(".chat-actions")?.remove();
      actionsShown = false;
      selectedItem = null;
    }

    /* ================= Firestore Load ================= */
    async function loadMenus() {
      try {
        const snap = await getDocs(query(collectionGroup(db, "menus"), limit(200)));
        return snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch {
        return [];
      }
    }

    function toBool(v) {
      if (typeof v === "boolean") return v;
      if (typeof v === "string") return v === "true";
      return false;
    }

    function toNum(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function recommend(point) {
      return menus
        .map(m => ({ ...m, price: toNum(m.price), available: toBool(m.available) }))
        .filter(m => m.available && m.price !== null && m.price <= point)
        .sort((a, b) => a.price - b.price)
        .slice(0, 3);
    }

    /* ================= Gemini ================= */
    async function getAIText(point, items) {
      const prompt = `
ë„ˆëŠ” í•œêµ­ì–´ ì±—ë´‡ 'ì¶”ì²œí•´ë“œë¦¬ë°'ì´ë‹¤.

ê·œì¹™:
- ì²« ë¬¸ì¥ì— ì‚¬ìš©ìì˜ í¬ì¸íŠ¸ ${point}ë¥¼ ì–¸ê¸‰
- itemsë§Œ ì„¤ëª…
- ê³„ì‚°/ì¶”ê°€ì¶”ì²œ ê¸ˆì§€
- ë§ˆì§€ë§‰ì— ì§ˆë¬¸ 1ê°œ
- JSONë§Œ ì¶œë ¥

items:
${JSON.stringify(items, null, 2)}
      `.trim();

      const res = await fetch(
        "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=" + GEMINI_API_KEY,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ role: "user", parts: [{ text: prompt }] }]
          })
        }
      );

      const data = await res.json();
      const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
      return JSON.parse(text.replace(/```json|```/g, "").trim());
    }

    /* ================= Actions ================= */
    function showOptions(items) {
      const wrap = document.createElement("div");
      wrap.className = "chat-options";

      items.forEach(item => {
        const btn = document.createElement("button");
        btn.className = "chat-option-button";
        btn.innerHTML = `<b>${item.name}</b><br>${item.price}P`;
        btn.onclick = () => {
          document.querySelectorAll(".chat-option-button").forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
          selectedItem = item;
        };
        wrap.appendChild(btn);
      });

      chatBody.appendChild(wrap);
    }

    function showActions() {
      if (actionsShown) return;
      actionsShown = true;

      const wrap = document.createElement("div");
      wrap.className = "chat-actions";

      const donate = document.createElement("button");
      donate.className = "chat-action-button";
      donate.textContent = "ê¸°ë¶€í•˜ê¸°";
      donate.onclick = () => {
        if (!selectedItem) return alert("ë©”ë‰´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”!");
        localStorage.setItem("donationItem", selectedItem.name);
        localStorage.setItem("donationAmount", selectedItem.price);
        window.location.href = "payment.html";
      };

      const end = document.createElement("button");
      end.className = "chat-action-button chat-action-sub";
      end.textContent = "ì¢…ë£Œí•˜ê¸°";
      end.onclick = () => location.href = "home.html";

      wrap.append(donate, end);
      chatBody.appendChild(wrap);
    }

    /* ================= Init ================= */
    addBubble("ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ì—ìš”â€¦", "bot");
    menus = await loadMenus();

    if (!menus.length) {
      addBubble("Firestoreì—ì„œ menus ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš” ğŸ˜¢", "bot");
    } else {
      addBubble(`ë©”ë‰´ ${menus.length}ê°œ ë¡œë”© ì™„ë£Œ!`, "bot");
    }

    /* ================= Submit ================= */
    chatForm.addEventListener("submit", async e => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;

      addBubble(text, "user");
      chatInput.value = "";
      clearActions();

      const num = text.match(/\d+/);
      if (!num) return addBubble("ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”!", "bot");

      const point = parseInt(num[0], 10);
      const items = recommend(point);

      if (!items.length) {
        return addCardBubble(`${point}Pë¡œ ê°€ëŠ¥í•œ ë©”ë‰´ê°€ ì—†ì–´ìš” ğŸ˜¢`);
      }

      addBubble("AIê°€ ì¶”ì²œ ì´ìœ ë¥¼ ë§Œë“¤ê³  ìˆì–´ìš” ğŸ¤–", "bot");

      let ai;
      try {
        ai = await getAIText(point, items);
      } catch {
        ai = {
          intro: `${point}Pë¡œ ê°€ëŠ¥í•œ ì¶”ì²œì´ì—ìš”!`,
          followUp: "ì–´ë–¤ ë©”ë‰´ê°€ ëŒë ¤ìš”?"
        };
      }

      const list = items.map(
        (i, idx) => `${idx + 1}. <b>${i.name}</b> (${i.price}P)`
      ).join("<br>");

      addCardBubble(`<b>${ai.intro}</b><br><br>${list}<br><br>${ai.followUp}`);
      showOptions(items);
      showActions();
    });
  </script>
</body>
</html>

