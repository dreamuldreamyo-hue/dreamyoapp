<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ì¶”ì²œí•´ë“œë¦¬ë°</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="screen chat-screen">

    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="chat-header">
      <a href="home.html" class="back">â€¹</a>
      <h1 class="chat-title">ì¶”ì²œí•´ë“œë¦¬ë°</h1>
    </header>

    <!-- ì±„íŒ… ì˜ì—­ -->
    <main class="chat-body" id="chat-body">
      <div class="chat-row bot">
        <div class="chat-bubble">
          ì•ˆë…•í•˜ì„¸ìš”! ğŸ˜Š ì €ëŠ” ë“œë¦¼ìš”ì˜ AI ì±—ë´‡<br />
          <b>ì¶”ì²œí•´ë“œë¦¬ë°</b> ì…ë‹ˆë‹¤.<br /><br />
          ë³´ìœ  í¬ì¸íŠ¸(ë§ˆì¼ë¦¬ì§€)ë¥¼ ì…ë ¥í•˜ë©´,<br />
          ê¸°ë¶€ ê°€ëŠ¥í•œ í’ˆëª©ì„ ì¶”ì²œí•´ë“œë¦´ê²Œìš”!<br />
          ì˜ˆ: 5000
        </div>
      </div>
    </main>

    <!-- í•˜ë‹¨ ì…ë ¥ì°½ -->
    <form class="chat-input-bar" id="chat-form">
      <input
        type="text"
        id="chat-input"
        class="chat-input"
        placeholder="ë³´ìœ  í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 5000)"
        autocomplete="off"
      />
      <button type="submit" class="chat-send-button">ì „ì†¡</button>
    </form>
  </div>

  <script src="./pwa.js"></script>

  <!-- âœ… Firebase (ëª¨ë“ˆ CDN ë°©ì‹) + Firestore + AI Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      limit,
      collectionGroup
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getAI, getGenerativeModel } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-ai.js";

    // âœ… ë„ˆê°€ ë³´ë‚´ì¤€ Firebase ì„¤ì • ê·¸ëŒ€ë¡œ
    const firebaseConfig = {
      apiKey: "AIzaSyBo1Ezg6tzCDDCGpBNWmJfCLe8hUsmLYi4",
      authDomain: "dreamyo-e42bb.firebaseapp.com",
      projectId: "dreamyo-e42bb",
      storageBucket: "dreamyo-e42bb.firebasestorage.app",
      messagingSenderId: "266927967076",
      appId: "1:266927967076:web:e5aca8599bc776b0774871",
      measurementId: "G-F6MPL89R9D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // (ì„ íƒ) ìµëª… ë¡œê·¸ì¸: Rulesì— auth ì¡°ê±´ ê±¸ì–´ë’€ì„ ë•Œ ëŒ€ë¹„
    const auth = getAuth(app);
    try { await signInAnonymously(auth); } catch (e) { /* ìµëª…ë¡œê·¸ì¸ ë§‰í˜€ë„ ì¼ë‹¨ ì§„í–‰ */ }

    // âœ… AI Logic
    const ai = getAI(app);
    // ëª¨ë¸ì€ ì½˜ì†”ì—ì„œ í—ˆìš©ëœ ê±¸ë¡œ. (ì•ˆ ë˜ë©´ "gemini-1.5-flash"ë¡œ ë°”ê¿”ë´)
    const model = getGenerativeModel(ai, { model: "gemini-1.5-flash" });

    // ---------- DOM ----------
    const chatBody = document.getElementById("chat-body");
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");

    // ---------- ìƒíƒœ ----------
    let actionsShown = false;
    let selectedItem = null;
    let menus = [];

    // ---------- UI helpers ----------
    function addBubble(text, type) {
      const row = document.createElement("div");
      row.className = "chat-row " + type;

      const bubble = document.createElement("div");
      bubble.className = "chat-bubble";
      bubble.innerHTML = String(text).replace(/\n/g, "<br />");

      row.appendChild(bubble);
      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function addCardBubble(htmlText) {
      const row = document.createElement("div");
      row.className = "chat-row bot";

      const bubble = document.createElement("div");
      bubble.className = "chat-bubble chat-bubble-card";
      bubble.innerHTML = String(htmlText);

      row.appendChild(bubble);
      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function clearOptionsAndActions() {
      document.querySelector(".chat-options")?.remove();
      document.querySelector(".chat-actions")?.remove();
      actionsShown = false;
      selectedItem = null;
    }

    // ---------- Firestore ë¡œë”© (ìµœëŒ€í•œ â€œë„¤ êµ¬ì¡°â€ë¥¼ ì°¾ì•„ì„œ ê°€ì ¸ì˜¤ê¸°) ----------
    async function loadMenusFlexible() {
      // 1) ìµœìƒìœ„ ì»¬ë ‰ì…˜ menus (ê¶Œì¥ êµ¬ì¡°)
      try {
        const s1 = await getDocs(query(collection(db, "menus"), limit(200)));
        if (!s1.empty) return s1.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) {}

      // 2) new_products/menus (collection -> doc -> collection êµ¬ì¡°ì¼ ìˆ˜ë„ ìˆì–´ ì‹¤íŒ¨ ê°€ëŠ¥, ê·¸ë˜ì„œ ë‹¤ìŒìœ¼ë¡œ)
      // 3) collectionGroup("menus") : ì–´ë–¤ ê²½ë¡œë“  menusë¼ëŠ” ì„œë¸Œì»¬ë ‰ì…˜ì„ ì „ë¶€ ê°€ì ¸ì˜´
      try {
        const s3 = await getDocs(query(collectionGroup(db, "menus"), limit(200)));
        if (!s3.empty) return s3.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) {}

      // 4) í˜¹ì‹œ ì´ì „ êµ¬ì¡° products (êµ¬ë²„ì „)
      try {
        const s4 = await getDocs(query(collection(db, "products"), limit(200)));
        if (!s4.empty) return s4.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) {}

      return [];
    }

    function toBool(v) {
      if (v === true) return true;
      if (v === false) return false;
      if (typeof v === "string") return v.toLowerCase() === "true";
      return false;
    }

    function toNum(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    // ---------- ì¶”ì²œ(ê³„ì‚°ì€ JSê°€ í•¨) ----------
    function getRecommendedMenus(point) {
      const candidates = menus
        .map(m => {
          const price = toNum(m.price ?? m.priceMileage);
          const available = toBool(m.available);
          return { ...m, price, available };
        })
        .filter(m => m.available === true && m.price !== null && m.price <= point)
        .sort((a, b) => (a.price - b.price));

      return candidates.slice(0, 3);
    }

    // ---------- Gemini: ë§(ì´ìœ /í›„ì†ì§ˆë¬¸)ë§Œ ìƒì„± ----------
    async function getAIText(point, items) {
      if (!items.length) {
        return {
          intro: `í˜„ì¬ ${point.toLocaleString()}Pë¡œëŠ” ì¶”ì²œ ê°€ëŠ¥í•œ ë©”ë‰´ê°€ ì—†ì–´ìš” ğŸ˜¢`,
          reasons: [],
          followUp: "í¬ì¸íŠ¸ë¥¼ ì¡°ê¸ˆ ë” ëª¨ìœ¼ê±°ë‚˜, ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ë¡œ ì°¾ì•„ë³¼ê¹Œìš”?"
        };
      }

      const system = `
ë„ˆëŠ” 'ë“œë¦¼ìš” ì¶”ì²œí•´ë“œë¦¬ë°' í•œêµ­ì–´ ì±—ë´‡ì´ë‹¤.

ì—„ê²©í•œ ê·œì¹™:
1) ê³„ì‚°/íŒë‹¨(í•„í„°ë§/ì •ë ¬/ê°€ê²© ë¹„êµ)ì€ í•˜ì§€ ì•ŠëŠ”ë‹¤. ì´ë¯¸ ì¶”ì²œëœ itemsë§Œ ì„¤ëª…í•œë‹¤.
2) ì²« ë¬¸ì¥ì— ì‚¬ìš©ìì˜ ë³´ìœ  í¬ì¸íŠ¸ë¥¼ ë°˜ë“œì‹œ ì–¸ê¸‰í•œë‹¤.
3) ê° ì¶”ì²œ í•­ëª©ë§ˆë‹¤ 1~2ë¬¸ì¥ìœ¼ë¡œ 'ë”°ëœ»í•˜ê³  ì§§ì€' ì¶”ì²œ ì´ìœ ë¥¼ ì“´ë‹¤.
4) ë§ˆì§€ë§‰ì— ì‚¬ìš©ìì˜ ì„ í˜¸ë¥¼ ë¬»ëŠ” ì§ˆë¬¸ì„ ë”± 1ê°œë§Œ í•œë‹¤.
5) ê²°ê³¼ëŠ” ë°˜ë“œì‹œ JSONë§Œ ì¶œë ¥í•œë‹¤. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ê¸ˆì§€.

ì¶œë ¥ JSON ìŠ¤í‚¤ë§ˆ:
{
  "intro": string,
  "reasons": [{"id": string, "reason": string}],
  "followUp": string
}
`.trim();

      const payload = {
        point,
        items: items.map(it => ({
          id: it.id,
          name: it.name,
          category: it.category ?? "cafe",
          price: it.price
        }))
      };

      const res = await model.generateContent([
        { text: system },
        { text: JSON.stringify(payload) }
      ]);

      const raw = res.response.text()
        .replace(/```json|```/g, "")
        .trim();

      return JSON.parse(raw);
    }

    // ---------- ì˜µì…˜ ë²„íŠ¼ (ê¸°ë¶€í•  ë©”ë‰´ ì„ íƒ) ----------
    function showOptions(items) {
      document.querySelector(".chat-options")?.remove();
      if (!items.length) return;

      const options = document.createElement("div");
      options.className = "chat-options";

      items.forEach((item) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "chat-option-button";

        const title = document.createElement("div");
        title.className = "chat-option-title";
        title.textContent = `[${item.category || "ê¸°ë¶€"}] ${item.name}`;

        const price = document.createElement("div");
        price.className = "chat-option-price";
        price.textContent = `${item.price.toLocaleString()}P`;

        btn.appendChild(title);
        btn.appendChild(price);

        btn.onclick = () => {
          document.querySelectorAll(".chat-option-button").forEach(el => el.classList.remove("selected"));
          btn.classList.add("selected");
          selectedItem = item;
        };

        options.appendChild(btn);
      });

      chatBody.appendChild(options);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // ---------- ì•¡ì…˜ ë²„íŠ¼ ----------
    function showActions() {
      if (actionsShown) return;
      actionsShown = true;

      const actions = document.createElement("div");
      actions.className = "chat-actions";

      const donateBtn = document.createElement("button");
      donateBtn.className = "chat-action-button";
      donateBtn.textContent = "ê¸°ë¶€í•˜ê¸°";
      donateBtn.onclick = () => {
        if (!selectedItem) {
          alert("ë¨¼ì € ê¸°ë¶€í•  í’ˆëª©ì„ í•˜ë‚˜ ì„ íƒí•´ ì£¼ì„¸ìš”!");
          return;
        }

        localStorage.setItem("donationItem", `[${selectedItem.category || "ê¸°ë¶€"}] ${selectedItem.name}`);
        localStorage.setItem("donationAmount", String(selectedItem.price || 0));
        localStorage.setItem("donationItemId", selectedItem.id || "");

        window.location.href = "payment.html";
      };

      const endBtn = document.createElement("button");
      endBtn.className = "chat-action-button chat-action-sub";
      endBtn.textContent = "ì¢…ë£Œí•˜ê¸°";
      endBtn.onclick = () => window.location.href = "home.html";

      actions.appendChild(donateBtn);
      actions.appendChild(endBtn);
      chatBody.appendChild(actions);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // ---------- ì´ˆê¸° ë¡œë”© ----------
    addBubble("ë©”ë‰´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ì—ìš”â€¦", "bot");
    menus = await loadMenusFlexible();

    // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´
    if (!menus.length) {
      addBubble("Firestoreì—ì„œ menus ë°ì´í„°ë¥¼ ëª» ì°¾ì•˜ì–´ ğŸ˜¢ (menus / collectionGroup(menus) / productsë¥¼ í™•ì¸í•´ì¤˜!)", "bot");
    } else {
      addBubble(`ë©”ë‰´ ${menus.length}ê°œ ë¡œë”© ì™„ë£Œ! í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•´ì¤˜ ğŸ˜Š`, "bot");
    }

    // ---------- ì…ë ¥ ì²˜ë¦¬ ----------
    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;

      addBubble(text, "user");
      chatInput.value = "";

      if (!menus.length) {
        addBubble("ì•„ì§ ë©”ë‰´ ë°ì´í„°ê°€ ì—†ì–´ì„œ ì¶”ì²œì„ ëª»í•´ìš”. Firestoreì— menus ë°ì´í„°ë¥¼ í™•ì¸í•´ì¤˜!", "bot");
        return;
      }

      const num = text.match(/\d+/g);
      if (!num) {
        addBubble("ìˆ«ìë¡œ í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•´ì¤˜! ì˜ˆ: 5000", "bot");
        return;
      }

      const point = parseInt(num[0], 10);
      clearOptionsAndActions();

      const items = getRecommendedMenus(point);

      // ë¨¼ì € ê¸°ë³¸ ì¹´ë“œ(ë¹ ë¥´ê²Œ)
      if (!items.length) {
        addCardBubble(`í˜„ì¬ <b>${point.toLocaleString()}P</b>ë¡œëŠ” ì¶”ì²œ ê°€ëŠ¥í•œ í’ˆëª©ì´ ì—†ì–´ìš” ğŸ˜¢<br>í¬ì¸íŠ¸ë¥¼ ë” ëª¨ì•„ë³´ê±°ë‚˜ ë‹¤ì‹œ ì…ë ¥í•´ë³¼ê¹Œìš”?`);
        return;
      }

      // AI ìƒì„±
      addBubble("ì ê¹ë§Œìš”! AIê°€ ì¶”ì²œ ì´ìœ ë¥¼ ë§Œë“¤ê³  ìˆì–´ìš”â€¦ ğŸ¤–", "bot");

      let aiText;
      try {
        aiText = await getAIText(point, items);
      } catch (err) {
        console.error(err);
        aiText = {
          intro: `í˜„ì¬ ${point.toLocaleString()}Pë¡œ ê°€ëŠ¥í•œ ì¶”ì²œì´ì—ìš”!`,
          reasons: items.map(it => ({ id: it.id, reason: "í¬ì¸íŠ¸ ì¡°ê±´ì— ë§ê³  ë§ì€ ë¶„ë“¤ì´ ì„ íƒí•˜ëŠ” ë©”ë‰´ì˜ˆìš”!" })),
          followUp: "ìŒë£Œ/ê°„ì‹ ì¤‘ ì–´ë–¤ ìª½ì„ ë” ì„ í˜¸í•´?"
        };
      }

      const reasonMap = new Map((aiText.reasons || []).map(r => [r.id, r.reason]));
      const listHtml = items.map((it, idx) => {
        const reason = reasonMap.get(it.id) || "í¬ì¸íŠ¸ ì¡°ê±´ì— ë§ëŠ” ë©”ë‰´ë¼ ì¶”ì²œí•´ìš”!";
        return `${idx + 1}. <b>${it.name}</b> (${it.price.toLocaleString()}P)<br><span style="opacity:.9">${reason}</span>`;
      }).join("<br><br>");

      const card = `
        <b>${aiText.intro || `í˜„ì¬ ${point.toLocaleString()}Pë¡œ ê°€ëŠ¥í•œ ì¶”ì²œì´ì—ìš”!`}</b><br><br>
        ${listHtml}<br><br>
        <b>Q.</b> ${aiText.followUp || "ì–´ë–¤ ì¢…ë¥˜ë¥¼ ë” ì›í•´? (ì˜ˆ: ì»¤í”¼/ë””ì €íŠ¸/í¸ì˜ì )"}
      `;

      addCardBubble(card);
      showOptions(items);
      showActions();
    });

  </script>
</body>
</html>
// âœ… Gemini Developer API (í”„ë¡ íŠ¸ ì§ì ‘ í˜¸ì¶œ) - ê²°ì œ ì—†ì´ ë°ëª¨ìš©
const GEMINI_API_KEY = "ì—¬ê¸°ì—_ë„ˆì˜_API_KEY_ë¶™ì—¬ë„£ê¸°"; // ì˜ˆ: AIza...

async function geminiExplain(point, items) {
  // items: [{name, price, category, storeName ...}] í˜•íƒœë©´ ì¶©ë¶„
  const prompt = `
ë„ˆëŠ” í•œêµ­ì–´ë¡œ ë‹µí•˜ëŠ” ë”°ëœ»í•œ ì±—ë´‡ "ì¶”ì²œí•´ë“œë¦¬ë°"ì´ì•¼.

ê·œì¹™:
- ì²« ë¬¸ì¥ì— ì‚¬ìš©ìì˜ ë³´ìœ  í¬ì¸íŠ¸(${point})ë¥¼ ë°˜ë“œì‹œ ì–¸ê¸‰í•´.
- ì•„ë˜ items(ì´ë¯¸ ì¶”ì²œëœ ëª©ë¡)ë§Œ ê°€ì§€ê³  ì¶”ì²œ ì´ìœ ë¥¼ 1~2ë¬¸ì¥ì”© ì¨.
- ë§ˆì§€ë§‰ì— ì„ í˜¸ë¥¼ ë¬»ëŠ” ì§ˆë¬¸ 1ê°œë§Œ í•´.
- ê³„ì‚°/ì¶”ê°€ì¶”ì²œ/ìƒˆë¡œìš´ ë©”ë‰´ ìƒì„± ê¸ˆì§€.
- ì¶œë ¥ì€ JSONë§Œ.

ì¶œë ¥ í˜•ì‹:
{
 "intro": string,
 "reasons":[{"idx":1,"reason":string},{"idx":2,"reason":string},{"idx":3,"reason":string}],
 "followUp": string
}

items:
${JSON.stringify(items, null, 2)}
`.trim();

  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      contents: [{ role: "user", parts: [{ text: prompt }] }],
      generationConfig: { temperature: 0.7, maxOutputTokens: 300 }
    })
  });

  if (!res.ok) {
    const t = await res.text();
    throw new Error("Gemini API error: " + t);
  }

  const data = await res.json();
  const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";

  // ì½”ë“œë¸”ë¡ ì œê±° + JSON íŒŒì‹±
  const cleaned = text.replace(/```json|```/g, "").trim();
  return JSON.parse(cleaned);
}
