<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ì¶”ì²œí•´ë“œë¦¬ë¯¸</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="screen chat-screen">

    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="chat-header">
      <a href="home.html" class="back">â€¹</a>
      <h1 class="chat-title">ì¶”ì²œí•´ë“œë¦¬ë¯¸</h1>
    </header>

    <!-- ì±„íŒ… ì˜ì—­ -->
    <main class="chat-body" id="chat-body">
      <div class="chat-row bot">
        <div class="chat-bubble">
          ì•ˆë…•í•˜ì„¸ìš”! ğŸ˜Š ì €ëŠ” ë“œë¦¼ìš”ì˜ AI ì±—ë´‡<br />
          <b>ë“œë¦¬ë¯¸</b> ì…ë‹ˆë‹¤.<br /><br />
          ë³´ìœ  í¬ì¸íŠ¸(ë§ˆì¼ë¦¬ì§€)ë¥¼ ì…ë ¥í•˜ë©´,<br />
          <b>í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€</b>ìœ¼ë¡œ ê¸°ë¶€ ê°€ëŠ¥í•œ í’ˆëª©ì„ ì¶”ì²œí•´ë“œë¦´ê²Œìš”!<br />
          (ê¸°ë³¸ 1km â†’ ì—†ìœ¼ë©´ 3km â†’ ê·¸ë˜ë„ ì—†ìœ¼ë©´ DCC ê¸°ì¤€)<br />
          ì˜ˆ: 5000
        </div>
      </div>
    </main>

    <!-- í•˜ë‹¨ ì…ë ¥ì°½ -->
    <form class="chat-input-bar" id="chat-form">
      <input
        type="text"
        id="chat-input"
        class="chat-input"
        placeholder="ë³´ìœ  í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 5000)"
        autocomplete="off"
      />
      <button type="submit" class="chat-send-button">ì „ì†¡</button>
    </form>
  </div>

  <script src="./pwa.js"></script>

  <!-- âœ… Firebase ëª¨ë“ˆ + Firestore + (Gemini Developer APIëŠ” fetchë¡œ í˜¸ì¶œ) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      limit,
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    /***********************
     * âœ… 0) ì„¤ì •ê°’
     ***********************/
    // âš ï¸ ì‹¤ì œ í•´ì»¤í†¤ ì œì¶œ/ê³µê°œ ì €ì¥ì†Œì—ì„œëŠ” í‚¤ë¥¼ íŒŒì¼ì— ë°•ì•„ ë„£ëŠ” ê±´ ë¹„ì¶”ì²œ.
    // ì§€ê¸ˆì€ "ë°ëª¨ìš© í”„ë¡ íŠ¸ ì§ì ‘ í˜¸ì¶œ" ë²„ì „ìœ¼ë¡œ ìœ ì§€.
    const GEMINI_API_KEY = "AIzaSyBpAyMWV2_TzH8XTPsOVLuWFBjgSqXKSYA";

    const firebaseConfig = {
      apiKey: "AIzaSyBo1Ezg6tzCDDCGpBNWmJfCLe8hUsmLYi4",
      authDomain: "dreamyo-e42bb.firebaseapp.com",
      projectId: "dreamyo-e42bb",
      storageBucket: "dreamyo-e42bb.firebasestorage.app",
      messagingSenderId: "266927967076",
      appId: "1:266927967076:web:e5aca8599bc776b0774871",
      measurementId: "G-F6MPL89R9D"
    };

    // ìœ„ì¹˜ê¶Œí•œ/PC ìœ„ì¹˜ ì´ìƒí•  ë•Œ ëŒ€ë¹„ìš© (ëŒ€ì „ DCC ê·¼ì²˜)
    const DCC_LOCATION = { lat: 36.3745, lng: 127.3870 };
    const RADIUS_1 = 1.0;
    const RADIUS_2 = 3.0;

    /***********************
     * âœ… 1) Firebase ì´ˆê¸°í™”
     ***********************/
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ìµëª…ë¡œê·¸ì¸ (rulesê°€ auth í•„ìš”ì¼ ë•Œ ëŒ€ë¹„)
    const auth = getAuth(app);
    try { await signInAnonymously(auth); } catch (e) {}

    /***********************
     * âœ… 2) DOM/ìƒíƒœ
     ***********************/
    const chatBody = document.getElementById("chat-body");
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");

    let menus = [];
    let storesMap = new Map(); // key: doc.id, value: store data
    let actionsShown = false;
    let selectedItem = null;

    /***********************
     * âœ… 3) UI í—¬í¼
     ***********************/
    function addBubble(text, type = "bot") {
      const row = document.createElement("div");
      row.className = "chat-row " + type;

      const bubble = document.createElement("div");
      bubble.className = "chat-bubble";
      bubble.innerHTML = String(text).replace(/\n/g, "<br />");

      row.appendChild(bubble);
      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function addCardBubble(htmlText) {
      const row = document.createElement("div");
      row.className = "chat-row bot";

      const bubble = document.createElement("div");
      bubble.className = "chat-bubble chat-bubble-card";
      bubble.innerHTML = String(htmlText);

      row.appendChild(bubble);
      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function clearOptionsAndActions() {
      document.querySelector(".chat-options")?.remove();
      document.querySelector(".chat-actions")?.remove();
      actionsShown = false;
      selectedItem = null;
    }

    /***********************
     * âœ… 4) Firestore ë¡œë“œ: menus + stores
     ***********************/
    function toBool(v) {
      if (v === true) return true;
      if (v === false) return false;
      if (typeof v === "string") return v.toLowerCase() === "true";
      return false;
    }

    function toNum(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    async function loadMenus() {
      const snap = await getDocs(query(collection(db, "menus"), limit(300)));
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    async function loadStores() {
      const snap = await getDocs(query(collection(db, "stores"), limit(300)));
      const m = new Map();
      snap.docs.forEach(d => m.set(d.id, { id: d.id, ...d.data() }));
      return m;
    }

    /***********************
     * âœ… 5) ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
     ***********************/
    function getCurrentLocation() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) {
          resolve({ ...DCC_LOCATION, source: "fallback(no-geolocation)" });
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            resolve({
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
              source: "device"
            });
          },
          () => {
            resolve({ ...DCC_LOCATION, source: "fallback(denied)" });
          },
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
        );
      });
    }

    /***********************
     * âœ… 6) ê±°ë¦¬ ê³„ì‚° (km)
     ***********************/
    function haversineKm(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const toRad = (x) => (x * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng / 2) ** 2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    /***********************
     * âœ… 7) ì¶”ì²œ ë¡œì§
     ***********************/
    function buildCandidates(point, baseLoc) {
      return menus
        .map(menu => {
          const price = toNum(menu.price ?? menu.priceMileage);
          const available = toBool(menu.available);
          const storeId = menu.storeId; // â­ï¸ ì´ ê°’ì´ stores ë¬¸ì„œIDë‘ ê°™ì•„ì•¼ í•¨
          const store = storeId ? storesMap.get(storeId) : null;

          const sLat = store ? toNum(store.lat) : null;
          const sLng = store ? toNum(store.lng) : null;

          let distanceKm = null;
          if (sLat !== null && sLng !== null) {
            distanceKm = haversineKm(baseLoc.lat, baseLoc.lng, sLat, sLng);
          }

          return {
            id: menu.id,
            name: menu.name ?? "",
            category: menu.category ?? "",
            type: menu.type ?? "",
            price,
            available,
            storeId: storeId ?? "",
            storeName: menu.storeName ?? (store?.name ?? ""),
            storeAddress: store?.address ?? "",
            storeLat: sLat,
            storeLng: sLng,
            distanceKm
          };
        })
        .filter(x => x.available === true)
        .filter(x => x.price !== null && x.price <= point)
        .filter(x => x.distanceKm !== null); // ê±°ë¦¬ ê³„ì‚° ê°€ëŠ¥í•œ ê²ƒë§Œ
    }

    function pickTop3(list) {
      return list
        .sort((a, b) => {
          if (a.distanceKm !== b.distanceKm) return a.distanceKm - b.distanceKm;
          return a.price - b.price;
        })
        .slice(0, 3);
    }

    function getRecommendedSmart(point, userLoc) {
      // 1) ì‚¬ìš©ì ìœ„ì¹˜ 1km
      const c1 = buildCandidates(point, userLoc).filter(x => x.distanceKm <= RADIUS_1);
      if (c1.length) {
        return { items: pickTop3(c1), used: { base: userLoc, radiusKm: RADIUS_1, mode: "user" } };
      }

      // 2) ì‚¬ìš©ì ìœ„ì¹˜ 3km
      const c2 = buildCandidates(point, userLoc).filter(x => x.distanceKm <= RADIUS_2);
      if (c2.length) {
        return { items: pickTop3(c2), used: { base: userLoc, radiusKm: RADIUS_2, mode: "user" } };
      }

      // 3) DCC 1km
      const c3 = buildCandidates(point, DCC_LOCATION).filter(x => x.distanceKm <= RADIUS_1);
      if (c3.length) {
        return { items: pickTop3(c3), used: { base: DCC_LOCATION, radiusKm: RADIUS_1, mode: "dcc" } };
      }

      // 4) DCC 3km
      const c4 = buildCandidates(point, DCC_LOCATION).filter(x => x.distanceKm <= RADIUS_2);
      if (c4.length) {
        return { items: pickTop3(c4), used: { base: DCC_LOCATION, radiusKm: RADIUS_2, mode: "dcc" } };
      }

      return { items: [], used: { base: userLoc, radiusKm: RADIUS_1, mode: "none" } };
    }

    /***********************
     * âœ… 8) Gemini Developer API: â€œì„¤ëª…/í›„ì†ì§ˆë¬¸â€ë§Œ ìƒì„±
     ***********************/
    async function geminiExplain(point, items) {
      if (!GEMINI_API_KEY) return null;

      const prompt = `
ë„ˆëŠ” í•œêµ­ì–´ë¡œ ë‹µí•˜ëŠ” ë”°ëœ»í•œ ì±—ë´‡ "ë“œë¦¬ë¯¸"ì•¼.

ì—„ê²©í•œ ê·œì¹™:
- ê³„ì‚°/íŒë‹¨/ì¶”ê°€ì¶”ì²œ ê¸ˆì§€. ì•„ë˜ items(ì´ë¯¸ ì¶”ì²œëœ ëª©ë¡)ë§Œ ì„¤ëª…í•œë‹¤.
- ì²« ë¬¸ì¥ì— ì‚¬ìš©ìì˜ ë³´ìœ  í¬ì¸íŠ¸(${point})ë¥¼ ë°˜ë“œì‹œ ì–¸ê¸‰í•œë‹¤.
- ê° í•­ëª©ë§ˆë‹¤ 1~2ë¬¸ì¥ ì¶”ì²œ ì´ìœ ë¥¼ ì“´ë‹¤.
- ë§ˆì§€ë§‰ì— ì„ í˜¸ë¥¼ ë¬»ëŠ” ì§ˆë¬¸ 1ê°œë§Œ í•œë‹¤.
- ì¶œë ¥ì€ ë°˜ë“œì‹œ JSONë§Œ. (ë‹¤ë¥¸ í…ìŠ¤íŠ¸/ì½”ë“œë¸”ë¡ ê¸ˆì§€)

ì¶œë ¥ í˜•ì‹:
{
 "intro": string,
 "reasons":[{"id":string,"reason":string}],
 "followUp": string
}

items:
${JSON.stringify(items.map(it => ({
  id: it.id,
  name: it.name,
  price: it.price,
  storeName: it.storeName,
  distanceKm: Math.round((it.distanceKm ?? 0) * 100) / 100
})), null, 2)}
`.trim();

      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ role: "user", parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.7, maxOutputTokens: 320 }
        })
      });

      if (!res.ok) {
        const t = await res.text();
        console.error("Gemini API error:", t);
        return null;
      }

      const data = await res.json();
      const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
      const cleaned = text.replace(/```json|```/g, "").trim();

      try {
        return JSON.parse(cleaned);
      } catch (e) {
        console.error("Gemini JSON parse fail:", cleaned);
        return null;
      }
    }

    /***********************
     * âœ… 9) ì˜µì…˜/ì•¡ì…˜ UI
     ***********************/
    function showOptions(items) {
      document.querySelector(".chat-options")?.remove();
      if (!items.length) return;

      const options = document.createElement("div");
      options.className = "chat-options";

      items.forEach((item) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "chat-option-button";

        const title = document.createElement("div");
        title.className = "chat-option-title";
        title.textContent = `${item.name} (${item.storeName || "ë§¤ì¥"})`;

        const price = document.createElement("div");
        price.className = "chat-option-price";
        price.textContent = `${item.price.toLocaleString()}P Â· ${Math.round(item.distanceKm * 1000)}m`;

        btn.appendChild(title);
        btn.appendChild(price);

        btn.onclick = () => {
          document.querySelectorAll(".chat-option-button").forEach(el => el.classList.remove("selected"));
          btn.classList.add("selected");
          selectedItem = item;
        };

        options.appendChild(btn);
      });

      chatBody.appendChild(options);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function showActions() {
      if (actionsShown) return;
      actionsShown = true;

      const actions = document.createElement("div");
      actions.className = "chat-actions";

      const donateBtn = document.createElement("button");
      donateBtn.className = "chat-action-button";
      donateBtn.textContent = "ê¸°ë¶€í•˜ê¸°";
      donateBtn.onclick = () => {
        if (!selectedItem) {
          alert("ë¨¼ì € ê¸°ë¶€í•  í’ˆëª©ì„ í•˜ë‚˜ ì„ íƒí•´ ì£¼ì„¸ìš”!");
          return;
        }

        localStorage.setItem("donationItem", selectedItem.name || "");
        localStorage.setItem("donationAmount", String(selectedItem.price || 0));
        localStorage.setItem("donationItemId", selectedItem.id || "");
        localStorage.setItem("donationStoreName", selectedItem.storeName || "");
        localStorage.setItem("donationStoreId", selectedItem.storeId || "");

        window.location.href = "payment.html";
      };

      const endBtn = document.createElement("button");
      endBtn.className = "chat-action-button chat-action-sub";
      endBtn.textContent = "ì¢…ë£Œí•˜ê¸°";
      endBtn.onclick = () => window.location.href = "home.html";

      actions.appendChild(donateBtn);
      actions.appendChild(endBtn);
      chatBody.appendChild(actions);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    /***********************
     * âœ… 10) ì´ˆê¸° ë¡œë”©
     ***********************/
    addBubble("ë©”ë‰´/ë§¤ì¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ì—ìš”â€¦", "bot");

    try {
      menus = await loadMenus();
      storesMap = await loadStores();

      addBubble(`ë©”ë‰´ ${menus.length}ê°œ Â· ë§¤ì¥ ${storesMap.size}ê°œ ë¡œë”© ì™„ë£Œ! í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•´ì¤˜ ğŸ˜Š`, "bot");
      addBubble(`ğŸ“ í¬ì¸íŠ¸ ì…ë ¥ ì‹œ ìœ„ì¹˜ ê¶Œí•œì„ ìš”ì²­í•˜ê³ , ê¸°ë³¸ 1km(ì—†ìœ¼ë©´ 3km)ë¡œ ì¶”ì²œí• ê²Œìš”!`, "bot");
    } catch (e) {
      console.error(e);
      addBubble("Firestore ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ ğŸ˜¢ (Rules/ì»¬ë ‰ì…˜ ì´ë¦„/ê¶Œí•œ í™•ì¸)", "bot");
    }

    /***********************
     * âœ… 11) ì…ë ¥ ì²˜ë¦¬
     ***********************/
    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;

      addBubble(text, "user");
      chatInput.value = "";
      clearOptionsAndActions();

      const num = text.match(/\d+/g);
      if (!num) {
        addBubble("ìˆ«ìë¡œ í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•´ì¤˜! ì˜ˆ: 5000", "bot");
        return;
      }

      if (!menus.length || !storesMap.size) {
        addBubble("ì•„ì§ ë°ì´í„°ê°€ ì—†ì–´ì„œ ì¶”ì²œì„ ëª»í•´ìš”. menus/stores ë°ì´í„°ë¥¼ í™•ì¸í•´ì¤˜!", "bot");
        return;
      }

      const point = parseInt(num[0], 10);

      addBubble("ğŸ“ ìœ„ì¹˜ í™•ì¸ ì¤‘â€¦ (ê¶Œí•œì„ í—ˆìš©í•˜ë©´ ë” ì •í™•í•´ì ¸ìš”!)", "bot");
      const userLoc = await getCurrentLocation();

      // ê¸°ì¤€ì¢Œí‘œ í‘œì‹œ(ë””ë²„ê·¸ìš©ì¸ë°, ì‚¬ìš©ìë„ ì´í•´í•˜ê¸° ì‰¬ì›€)
      addBubble(`ğŸ“Œ ê¸°ì¤€ ì¢Œí‘œ: ${userLoc.lat.toFixed(6)}, ${userLoc.lng.toFixed(6)} (${userLoc.source})`, "bot");

      const { items, used } = getRecommendedSmart(point, userLoc);

      // ì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì²œí–ˆëŠ”ì§€ ì•ˆë‚´
      if (used.mode === "user") {
        addBubble(`í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ ${used.radiusKm}km ì´ë‚´ì—ì„œ ì¶”ì²œí• ê²Œìš”!`, "bot");
      } else if (used.mode === "dcc") {
        addBubble(`í˜„ì¬ ìœ„ì¹˜ì—ì„œ í›„ë³´ê°€ ì—†ì–´ì„œ, DCC ê¸°ì¤€ ${used.radiusKm}kmë¡œ ì¶”ì²œí• ê²Œìš”!`, "bot");
      }

      if (!items.length) {
        addCardBubble(`
          í˜„ì¬ <b>${point.toLocaleString()}P</b>ë¡œëŠ”<br/>
          <b>ê·¼ì²˜ ë§¤ì¥(1~3km)</b>ì—ì„œ ê¸°ë¶€ ê°€ëŠ¥í•œ í’ˆëª©ì´ ì—†ì–´ìš” ğŸ˜¢<br/><br/>
          âœ… í™•ì¸ í¬ì¸íŠ¸<br/>
          1) menus.storeId ê°’ì´ stores ë¬¸ì„œIDì™€ ì •í™•íˆ ê°™ì€ì§€<br/>
          2) stores ë¬¸ì„œì— lat/lngê°€ ìˆ«ìì¸ì§€<br/>
          3) ë©”ë‰´ available=true ì¸ì§€
        `);
        return;
      }

      addBubble("AIê°€ ì¶”ì²œ ì´ìœ ë¥¼ ë§Œë“¤ê³  ìˆì–´ìš”â€¦ ğŸ¤–", "bot");
      const ai = await geminiExplain(point, items);

      const intro = ai?.intro || `í˜„ì¬ ${point.toLocaleString()}Pë¡œ ê°€ëŠ¥í•œ ì¶”ì²œì´ì—ìš”!`;
      const reasonsMap = new Map((ai?.reasons || []).map(r => [r.id, r.reason]));
      const followUp = ai?.followUp || "ì»¤í”¼/í¸ì˜ì /ë””ì €íŠ¸ ì¤‘ ì–´ë–¤ ìª½ì´ ë” ì¢‹ì•„?";

      const listHtml = items.map((it, idx) => {
        const reason = reasonsMap.get(it.id) || "ì§€ê¸ˆ í¬ì¸íŠ¸ë¡œ ê°€ëŠ¥í•˜ê³ , ê°€ê¹Œìš´ ë§¤ì¥ì´ë¼ ì¶”ì²œí•´ìš”!";
        return `
          ${idx + 1}. <b>${it.name}</b> (${it.price.toLocaleString()}P)<br/>
          <span style="opacity:.9">
            ${it.storeName ? `${it.storeName} Â· ` : ""}${Math.round(it.distanceKm * 1000)}m<br/>
            ${reason}
          </span>
        `;
      }).join("<br><br>");

      addCardBubble(`
        <b>${intro}</b><br><br>
        ${listHtml}<br><br>
        <b>Q.</b> ${followUp}
      `);

      showOptions(items);
      showActions();
    });
  </script>
</body>
</html>
