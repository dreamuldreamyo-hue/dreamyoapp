<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì¶”ì²œí•´ë“œë¦¬ë°</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="screen chat-screen">

    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="chat-header">
      <a href="home.html" class="back">â€¹</a>
      <h1 class="chat-title">ì¶”ì²œí•´ë“œë¦¬ë°</h1>
    </header>

    <!-- ì±„íŒ… ì˜ì—­ -->
    <main class="chat-body" id="chat-body">
      <!-- ì²˜ìŒì— ë³´ì´ëŠ” ë´‡ ì¸ì‚¬ë§ -->
      <div class="chat-row bot">
        <div class="chat-bubble">
          ì•ˆë…•í•˜ì„¸ìš”! ğŸ˜Š ì €ëŠ” ë“œë¦¼ìš”ì˜ AI ì±—ë´‡<br />
          <b>ì¶”ì²œí•´ë“œë¦¬ë°</b> ì…ë‹ˆë‹¤.<br /><br />
          ê¸°ì°¨ ë§ˆì¼ë¦¬ì§€ë¡œ ê¸°ë¶€í•  ìˆ˜ ìˆëŠ” í’ˆëª©ì„<br />
          ì¶”ì²œí•´ë“œë¦´ê²Œìš”.<br />
          ë³´ìœ  í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”!
        </div>
      </div>
    </main>

    <!-- í•˜ë‹¨ ì…ë ¥ì°½ -->
    <form class="chat-input-bar" id="chat-form">
      <input
        type="text"
        id="chat-input"
        class="chat-input"
        placeholder="ë³´ìœ  ë§ˆì¼ë¦¬ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 5000)"
        autocomplete="off"
      />
      <button type="submit" class="chat-send-button">ì „ì†¡</button>
    </form>
  </div>

   <!-- ğŸ”¥ Firebase SDK ì¶”ê°€ -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>

  <!-- ğŸ”¥ Firestore ê¸°ë°˜ ì¶”ì²œ ì±—ë´‡ ë¡œì§ -->
  <script>
    const chatBody = document.getElementById("chat-body");
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");

    let actionsShown = false;        // ê¸°ë¶€í•˜ê¸°/ì¢…ë£Œí•˜ê¸° ë²„íŠ¼ ìƒì„± ì—¬ë¶€
    let selectedItem = null;         // ì„ íƒëœ ìƒí’ˆ ê°ì²´
    let selectedAmount = 0;          // ì„ íƒëœ ìƒí’ˆ ê°€ê²©(P)
    let products = [];               // Firestoreì—ì„œ ê°€ì ¸ì˜¨ ì „ì²´ ìƒí’ˆ

    // ---------- 0. Firestoreì—ì„œ products í•œ ë²ˆë§Œ ê°€ì ¸ì˜¤ê¸° ----------
    db.collection("products")
      .get()
      .then((snapshot) => {
        products = snapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        }));
        console.log("ìƒí’ˆ ëª©ë¡ ë¡œë”© ì™„ë£Œ:", products);
      })
      .catch((err) => {
        console.error("ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
      });

    // ---------- ê³µí†µ: ë§í’ì„ /ì¹´ë“œ UI ----------
    function addBubble(text, type) {
      const row = document.createElement("div");
      row.className = "chat-row " + type;

      const bubble = document.createElement("div");
      bubble.className = "chat-bubble";
      bubble.innerHTML = text.replace(/\n/g, "<br />");

      row.appendChild(bubble);
      chatBody.appendChild(row);

      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function addCardBubble(text) {
      const row = document.createElement("div");
      row.className = "chat-row bot";

      const bubble = document.createElement("div");
      bubble.className = "chat-bubble chat-bubble-card";
      bubble.innerHTML = text.replace(/\n/g, "<br />");

      row.appendChild(bubble);
      chatBody.appendChild(row);

      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // ---------- 1. ì¶”ì²œìš© í…ìŠ¤íŠ¸ & ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ë§Œë“¤ê¸° ----------
    function getRecommendedItems(point) {
      if (!products.length) return [];

      // price <= point ì¸ ìƒí’ˆë§Œ ê³¨ë¼ì„œ ê°€ê²© ì˜¤ë¦„ì°¨ìˆœ
      const candidates = products
        .filter(
          (p) => typeof p.price === "number" && p.price <= point
        )
        .sort((a, b) => a.price - b.price);

      // ìƒìœ„ 3ê°œë§Œ ì¶”ì²œ
      return candidates.slice(0, 3);
    }

    function makeRecommendationText(point, items) {
      if (!items.length) {
        return (
          `í˜„ì¬ <b>${point.toLocaleString()}í¬ì¸íŠ¸</b>ë¡œëŠ” ë“±ë¡ëœ ê¸°ë¶€ ìƒí’ˆì´ ì—†ì–´ìš” ğŸ˜¢<br>` +
          `ì¡°ê¸ˆ ë” í¬ì¸íŠ¸ë¥¼ ëª¨ìœ¼ê±°ë‚˜, ê¸ˆì•¡ì„ ë‹¤ì‹œ ì…ë ¥í•´ ë³¼ê¹Œìš”?`
        );
      }

      const listHtml = items
        .map((item, idx) => {
          const category = item.category || "ê¸°ë¶€";
          const priceText = item.price
            ? item.price.toLocaleString() + "P"
            : "";
          return `${idx + 1}. [${category}] ${item.name} (${priceText})`;
        })
        .join("<br>");

      return (
        `í˜„ì¬ <b>${point.toLocaleString()}í¬ì¸íŠ¸</b>ë¡œ ê¸°ë¶€ ê°€ëŠ¥í•œ í’ˆëª©ì´ì—ìš”.<br><br>` +
        listHtml +
        `<br><br>ì›í•˜ëŠ” í’ˆëª©ì„ ê³¨ë¼ ì•„ì´ë“¤ì—ê²Œ ë”°ëœ»í•œ ì‘ì›ì„ ì „í•´ë³¼ê¹Œìš”? ğŸ˜Š`
      );
    }

    // ---------- 2. í’ˆëª© ì„ íƒ ë²„íŠ¼ë“¤ (Firestore ë°ì´í„° ê¸°ë°˜) ----------
    function showOptions(items) {
      const old = document.querySelector(".chat-options");
      if (old) old.remove();

      if (!items || !items.length) return;

      const options = document.createElement("div");
      options.className = "chat-options";

      items.forEach((item) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "chat-option-button";

        const title = document.createElement("div");
        title.className = "chat-option-title";
        title.textContent = `[${item.category || "ê¸°ë¶€"}] ${item.name}`;

        const price = document.createElement("div");
        price.className = "chat-option-price";
        price.textContent = item.price.toLocaleString() + "P";

        btn.appendChild(title);
        btn.appendChild(price);

        btn.onclick = () => {
          document
            .querySelectorAll(".chat-option-button")
            .forEach((el) => el.classList.remove("selected"));

          btn.classList.add("selected");
          selectedItem = item;
          selectedAmount = item.price;
        };

        options.appendChild(btn);
      });

      chatBody.appendChild(options);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // ---------- 3. ê¸°ë¶€í•˜ê¸° / ì¢…ë£Œí•˜ê¸° ë²„íŠ¼ ----------
    function showActions() {
      if (actionsShown) return;
      actionsShown = true;

      const actions = document.createElement("div");
      actions.className = "chat-actions";

      const donateBtn = document.createElement("button");
      donateBtn.className = "chat-action-button";
      donateBtn.textContent = "ê¸°ë¶€í•˜ê¸°";

      donateBtn.onclick = () => {
        if (!selectedItem) {
          alert("ë¨¼ì € ê¸°ë¶€í•  í’ˆëª©ì„ í•˜ë‚˜ ì„ íƒí•´ ì£¼ì„¸ìš”!");
          return;
        }

        localStorage.setItem(
          "donationItem",
          `[${selectedItem.category || "ê¸°ë¶€"}] ${selectedItem.name}`
        );
        localStorage.setItem(
          "donationAmount",
          String(selectedItem.price || 0)
        );
        localStorage.setItem("donationItemId", selectedItem.id || "");

        window.location.href = "payment.html";
      };

      const endBtn = document.createElement("button");
      endBtn.className = "chat-action-button chat-action-sub";
      endBtn.textContent = "ì¢…ë£Œí•˜ê¸°";
      endBtn.onclick = () => {
        window.location.href = "home.html";
      };

      actions.appendChild(donateBtn);
      actions.appendChild(endBtn);

      chatBody.appendChild(actions);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // ---------- 4. ì±„íŒ… ì…ë ¥ ì²˜ë¦¬ ----------
    chatForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;

      addBubble(text, "user");
      chatInput.value = "";

      if (!products.length) {
        setTimeout(() => {
          addBubble(
            "ì ì‹œë§Œìš”! ì•„ì§ ê¸°ë¶€ ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ì—ìš”. ë‹¤ì‹œ í•œ ë²ˆë§Œ ì…ë ¥í•´ ì£¼ì„¸ìš” ğŸ˜Š",
            "bot"
          );
        }, 500);
        return;
      }

      const num = text.match(/\d+/g);
      if (!num) {
        setTimeout(() => {
          addBubble(
            "ë³´ìœ  ë§ˆì¼ë¦¬ì§€ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ë©´, ê¸°ë¶€ ê°€ëŠ¥í•œ í’ˆëª©ì„ ì¶”ì²œí•´ë“œë¦´ê²Œìš”! ì˜ˆ: 5000",
            "bot"
          );
        }, 500);
        return;
      }

      const point = parseInt(num[0], 10);
      const items = getRecommendedItems(point);

      setTimeout(() => {
        const reply = makeRecommendationText(point, items);
        addCardBubble(reply);
        showOptions(items);
        showActions();
      }, 600);
    });
  </script>
</body>
</html>


  <script>
    const chatBody = document.getElementById("chat-body");
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");

    let actionsShown = false;        // ê¸°ë¶€í•˜ê¸°/ì¢…ë£Œí•˜ê¸° ë²„íŠ¼ ìƒì„± ì—¬ë¶€
    let selectedItem = null;         // ì„ íƒëœ ìƒí’ˆ ê°ì²´
    let selectedAmount = 0;          // ì„ íƒëœ ìƒí’ˆ ê°€ê²©(P)
    let products = [];               // Firestoreì—ì„œ ê°€ì ¸ì˜¨ ì „ì²´ ìƒí’ˆ
    let lastRecommended = [];        // ë§ˆì§€ë§‰ ì¶”ì²œ ë¦¬ìŠ¤íŠ¸

    // ---------- 0. Firestoreì—ì„œ products í•œ ë²ˆë§Œ ê°€ì ¸ì˜¤ê¸° ----------
    db.collection("products")
      .get()
      .then((snapshot) => {
        products = snapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        }));
        console.log("ìƒí’ˆ ëª©ë¡ ë¡œë”© ì™„ë£Œ:", products);
      })
      .catch((err) => {
        console.error("ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
      });

    // ---------- ê³µí†µ: ë§í’ì„ /ì¹´ë“œ UI ----------
    function addBubble(text, type) {
      const row = document.createElement("div");
      row.className = "chat-row " + type;

      const bubble = document.createElement("div");
      bubble.className = "chat-bubble";
      bubble.innerHTML = text.replace(/\n/g, "<br />");

      row.appendChild(bubble);
      chatBody.appendChild(row);

      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function addCardBubble(text) {
      const row = document.createElement("div");
      row.className = "chat-row bot";

      const bubble = document.createElement("div");
      bubble.className = "chat-bubble chat-bubble-card";
      bubble.innerHTML = text.replace(/\n/g, "<br />");

      row.appendChild(bubble);
      chatBody.appendChild(row);

      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // ---------- 1. ì¶”ì²œìš© í…ìŠ¤íŠ¸ & ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ë§Œë“¤ê¸° ----------

    function getRecommendedItems(point) {
      if (!products.length) return [];

      // price <= point ì¸ ìƒí’ˆë§Œ ê³¨ë¼ì„œ ê°€ê²© ì˜¤ë¦„ì°¨ìˆœ
      const candidates = products
        .filter(
          (p) => typeof p.price === "number" && p.price <= point
        )
        .sort((a, b) => a.price - b.price);

      // ìƒìœ„ 3ê°œë§Œ ì¶”ì²œ
      return candidates.slice(0, 3);
    }

    function makeRecommendationText(point, items) {
      if (!items.length) {
        return (
          `í˜„ì¬ <b>${point.toLocaleString()}í¬ì¸íŠ¸</b>ë¡œëŠ” ë“±ë¡ëœ ê¸°ë¶€ ìƒí’ˆì´ ì—†ì–´ìš” ğŸ˜¢<br>` +
          `ì¡°ê¸ˆ ë” í¬ì¸íŠ¸ë¥¼ ëª¨ìœ¼ê±°ë‚˜, ê¸ˆì•¡ì„ ë‹¤ì‹œ ì…ë ¥í•´ ë³¼ê¹Œìš”?`
        );
      }

      const listHtml = items
        .map((item, idx) => {
          const category = item.category || "ê¸°ë¶€";
          const priceText = item.price
            ? item.price.toLocaleString() + "P"
            : "";
          return `${idx + 1}. [${category}] ${item.name} (${priceText})`;
        })
        .join("<br>");

      return (
        `í˜„ì¬ <b>${point.toLocaleString()}í¬ì¸íŠ¸</b>ë¡œ ê¸°ë¶€ ê°€ëŠ¥í•œ í’ˆëª©ì´ì—ìš”.<br><br>` +
        listHtml +
        `<br><br>ì›í•˜ëŠ” í’ˆëª©ì„ ê³¨ë¼ ì•„ì´ë“¤ì—ê²Œ ë”°ëœ»í•œ ì‘ì›ì„ ì „í•´ë³¼ê¹Œìš”? ğŸ˜Š`
      );
    }

    // ---------- 2. í’ˆëª© ì„ íƒ ë²„íŠ¼ë“¤ ë³´ì—¬ì£¼ê¸° (Firestore ë°ì´í„° ê¸°ë°˜) ----------

    function showOptions(items) {
      // ì´ì „ ì˜µì…˜ì´ ìˆìœ¼ë©´ ì œê±°
      const old = document.querySelector(".chat-options");
      if (old) old.remove();

      if (!items || !items.length) return;

      const options = document.createElement("div");
      options.className = "chat-options";

      items.forEach((item) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "chat-option-button";

        const title = document.createElement("div");
        title.className = "chat-option-title";
        title.textContent = `[${item.category || "ê¸°ë¶€"}] ${item.name}`;

        const price = document.createElement("div");
        price.className = "chat-option-price";
        price.textContent = item.price.toLocaleString() + "P";

        btn.appendChild(title);
        btn.appendChild(price);

        btn.onclick = () => {
          // ëª¨ë‘ ì„ íƒ í•´ì œ
          document
            .querySelectorAll(".chat-option-button")
            .forEach((el) => el.classList.remove("selected"));

          // ì´ ë²„íŠ¼ë§Œ ì„ íƒ í‘œì‹œ
          btn.classList.add("selected");

          selectedItem = item;
          selectedAmount = item.price;
        };

        options.appendChild(btn);
      });

      chatBody.appendChild(options);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // ---------- 3. ê¸°ë¶€í•˜ê¸° / ì¢…ë£Œí•˜ê¸° ë²„íŠ¼ ì˜ì—­ ----------

    function showActions() {
      if (actionsShown) return;
      actionsShown = true;

      const actions = document.createElement("div");
      actions.className = "chat-actions";

      const donateBtn = document.createElement("button");
      donateBtn.className = "chat-action-button";
      donateBtn.textContent = "ê¸°ë¶€í•˜ê¸°";

      donateBtn.onclick = () => {
        if (!selectedItem) {
          alert("ë¨¼ì € ê¸°ë¶€í•  í’ˆëª©ì„ í•˜ë‚˜ ì„ íƒí•´ ì£¼ì„¸ìš”!");
          return;
        }

        // ê²°ì œ í™”ë©´ì—ì„œ ì‚¬ìš©í•  ì •ë³´ ì €ì¥
        localStorage.setItem(
          "donationItem",
          `[${selectedItem.category || "ê¸°ë¶€"}] ${selectedItem.name}`
        );
        localStorage.setItem(
          "donationAmount",
          String(selectedItem.price || 0)
        );
        // í•„ìš”í•˜ë‹¤ë©´ idë„ ë„˜ê¸¸ ìˆ˜ ìˆìŒ
        localStorage.setItem("donationItemId", selectedItem.id || "");

        window.location.href = "payment.html";
      };

      const endBtn = document.createElement("button");
      endBtn.className = "chat-action-button chat-action-sub";
      endBtn.textContent = "ì¢…ë£Œí•˜ê¸°";
      endBtn.onclick = () => {
        window.location.href = "home.html";
      };

      actions.appendChild(donateBtn);
      actions.appendChild(endBtn);

      chatBody.appendChild(actions);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // ---------- 4. ì±„íŒ… ì…ë ¥ ì²˜ë¦¬ ----------

    chatForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;

      // ì‚¬ìš©ì ë§í’ì„  ì¶”ê°€
      addBubble(text, "user");
      chatInput.value = "";

      // Firestore ë°ì´í„° ì•„ì§ ì•ˆ ì˜¨ ê²½ìš°
      if (!products.length) {
        setTimeout(() => {
          addBubble(
            "ì ì‹œë§Œìš”! ì•„ì§ ê¸°ë¶€ ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ì—ìš”. ë‹¤ì‹œ í•œ ë²ˆë§Œ ì…ë ¥í•´ ì£¼ì„¸ìš” ğŸ˜Š",
            "bot"
          );
        }, 500);
        return;
      }

      // ìˆ«ì(í¬ì¸íŠ¸) ì¶”ì¶œ
      const num = text.match(/\d+/g);
      if (!num) {
        setTimeout(() => {
          addBubble(
            "ë³´ìœ  ë§ˆì¼ë¦¬ì§€ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ë©´, ê¸°ë¶€ ê°€ëŠ¥í•œ í’ˆëª©ì„ ì¶”ì²œí•´ë“œë¦´ê²Œìš”! ì˜ˆ: 5000",
            "bot"
          );
        }, 500);
        return;
      }

      const point = parseInt(num[0], 10);

      // ì¶”ì²œ ê³„ì‚°
      const items = getRecommendedItems(point);
      lastRecommended = items;

      setTimeout(() => {
        const reply = makeRecommendationText(point, items);
        addCardBubble(reply);   // ì¹´ë“œí˜• ë§í’ì„ 
        showOptions(items);     // Firestore ê¸°ë°˜ í’ˆëª© ì„ íƒ ë²„íŠ¼ë“¤
        showActions();          // ê¸°ë¶€í•˜ê¸°/ì¢…ë£Œí•˜ê¸° ë²„íŠ¼
      }, 600);
    });
  </script>
</body>
</html>
