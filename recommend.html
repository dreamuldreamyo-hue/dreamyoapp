<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ì¶”ì²œí•´ë“œë¦¬ë°</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="screen chat-screen">

    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="chat-header">
      <a href="home.html" class="back">â€¹</a>
      <h1 class="chat-title">ì¶”ì²œí•´ë“œë¦¬ë°</h1>
    </header>

    <!-- ì±„íŒ… ì˜ì—­ -->
    <main class="chat-body" id="chat-body">
      <div class="chat-row bot">
        <div class="chat-bubble">
          ì•ˆë…•í•˜ì„¸ìš”! ğŸ˜Š ì €ëŠ” ë“œë¦¼ìš”ì˜ AI ì±—ë´‡<br />
          <b>ì¶”ì²œí•´ë“œë¦¬ë°</b> ì…ë‹ˆë‹¤.<br /><br />
          ë³´ìœ  í¬ì¸íŠ¸(ë§ˆì¼ë¦¬ì§€)ë¥¼ ì…ë ¥í•˜ë©´,<br />
          <b>í˜„ì¬ ìœ„ì¹˜ 5km ë‚´</b>ì—ì„œ ê¸°ë¶€ ê°€ëŠ¥í•œ í’ˆëª©ì„<br />
          ì¶”ì²œí•´ë“œë¦´ê²Œìš”!<br />
          ì˜ˆ: 5000
        </div>
      </div>
    </main>

    <!-- í•˜ë‹¨ ì…ë ¥ì°½ -->
    <form class="chat-input-bar" id="chat-form">
      <input
        type="text"
        id="chat-input"
        class="chat-input"
        placeholder="ë³´ìœ  í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 5000)"
        autocomplete="off"
      />
      <button type="submit" class="chat-send-button">ì „ì†¡</button>
    </form>
  </div>

  <script src="./pwa.js"></script>

  <!-- âœ… Firebase ëª¨ë“ˆ CDN + Firestore + (ìµëª…ë¡œê·¸ì¸ ì˜µì…˜) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      limit,
      collectionGroup
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    // âœ… ë„ˆ Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyBo1Ezg6tzCDDCGpBNWmJfCLe8hUsmLYi4",
      authDomain: "dreamyo-e42bb.firebaseapp.com",
      projectId: "dreamyo-e42bb",
      storageBucket: "dreamyo-e42bb.firebasestorage.app",
      messagingSenderId: "266927967076",
      appId: "1:266927967076:web:e5aca8599bc776b0774871",
      measurementId: "G-F6MPL89R9D"
    };

    // âœ… (ë°ëª¨ìš©) Gemini Developer API í‚¤: ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°
    const GEMINI_API_KEY = "AIzaSyBpAyMWV2_TzH8XTPsOVLuWFBjgSqXKSYA";

    // âœ… ìœ„ì¹˜ í—ˆìš© ì•ˆ ë˜ë©´ fallback (ëŒ€ì „ ì»¨ë²¤ì…˜ì„¼í„° ê·¼ì²˜)
    const FALLBACK_LOCATION = { lat: 36.3745, lng: 127.3870 };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // (ì„ íƒ) ìµëª… ë¡œê·¸ì¸: Firestore rulesê°€ auth í•„ìš”í•  ë•Œ ëŒ€ë¹„
    const auth = getAuth(app);
    try { await signInAnonymously(auth); } catch (e) {}

    // ---------- DOM ----------
    const chatBody = document.getElementById("chat-body");
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");

    // ---------- ìƒíƒœ ----------
    let actionsShown = false;
    let selectedItem = null;
    let menus = []; // Firestoreì—ì„œ ê°€ì ¸ì˜¨ ë©”ë‰´ ëª©ë¡

    // ---------- UI helpers ----------
    function addBubble(text, type) {
      const row = document.createElement("div");
      row.className = "chat-row " + type;

      const bubble = document.createElement("div");
      bubble.className = "chat-bubble";
      bubble.innerHTML = String(text).replace(/\n/g, "<br />");

      row.appendChild(bubble);
      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function addCardBubble(htmlText) {
      const row = document.createElement("div");
      row.className = "chat-row bot";

      const bubble = document.createElement("div");
      bubble.className = "chat-bubble chat-bubble-card";
      bubble.innerHTML = String(htmlText);

      row.appendChild(bubble);
      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function clearOptionsAndActions() {
      document.querySelector(".chat-options")?.remove();
      document.querySelector(".chat-actions")?.remove();
      actionsShown = false;
      selectedItem = null;
    }

    // ---------- íƒ€ì… ë³€í™˜ ----------
    function toBool(v) {
      if (v === true) return true;
      if (v === false) return false;
      if (typeof v === "string") return v.toLowerCase() === "true";
      return false;
    }
    function toNum(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    // ---------- ê±°ë¦¬ ê³„ì‚° (km) ----------
    function distanceKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // ---------- í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ----------
    async function getUserLocation() {
      if (!navigator.geolocation) {
        return { ...FALLBACK_LOCATION, source: "fallback(no-geolocation)" };
      }

      return new Promise((resolve) => {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            resolve({
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
              source: "gps"
            });
          },
          () => {
            resolve({ ...FALLBACK_LOCATION, source: "fallback(denied)" });
          },
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
        );
      });
    }

    // ---------- Firestoreì—ì„œ ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ê¸° (ë„¤ êµ¬ì¡° ìµœëŒ€í•œ ìë™ ëŒ€ì‘) ----------
    async function loadMenusFlexible() {
      // 1) ìµœìƒìœ„ menus
      try {
        const s1 = await getDocs(query(collection(db, "menus"), limit(300)));
        if (!s1.empty) return s1.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) {}

      // 2) ì–´ë–¤ ê²½ë¡œë“  "menus" ì„œë¸Œì»¬ë ‰ì…˜ ì „ë¶€ (new_products/menus í¬í•¨ ê°€ëŠ¥)
      try {
        const s2 = await getDocs(query(collectionGroup(db, "menus"), limit(300)));
        if (!s2.empty) return s2.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) {}

      // 3) êµ¬ë²„ì „ products
      try {
        const s3 = await getDocs(query(collection(db, "products"), limit(300)));
        if (!s3.empty) return s3.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) {}

      return [];
    }

    // ---------- ì¶”ì²œ í›„ë³´ ë§Œë“¤ê¸°: (1km) + (ê°€ê²©<=í¬ì¸íŠ¸) + available=true ----------
    function getRecommendedMenus(point, userLat, userLng) {
      const candidates = menus
        .map(m => {
          const price = toNum(m.price ?? m.priceMileage ?? m.amount);
          const available = toBool(m.available);
          const lat = toNum(m.lat);
          const lng = toNum(m.lng);
          const pop = toNum(m.popularityScore) ?? 0;

          // lat/lng ì—†ìœ¼ë©´ ì œì™¸ (ìœ„ì¹˜ ê¸°ë°˜ ì¡°ê±´)
          if (lat === null || lng === null) return null;

          const dist = distanceKm(userLat, userLng, lat, lng);

          return {
            ...m,
            price,
            available,
            lat,
            lng,
            distanceKm: dist,
            popularityScoreNum: pop
          };
        })
        .filter(Boolean)
        .filter(m => m.available === true)
        .filter(m => m.distanceKm <= 1.0)
        .filter(m => m.price !== null && m.price <= point)
        // ì •ë ¬: ê°€ê¹Œìš´ ìˆœ -> ê°€ê²© ë‚®ì€ ìˆœ -> ì¸ê¸° ë†’ì€ ìˆœ
        .sort((a, b) => {
          if (a.distanceKm !== b.distanceKm) return a.distanceKm - b.distanceKm;
          if (a.price !== b.price) return a.price - b.price;
          return (b.popularityScoreNum ?? 0) - (a.popularityScoreNum ?? 0);
        });

      return candidates.slice(0, 3);
    }

    // ---------- Gemini í˜¸ì¶œ: "ì„¤ëª…ë§Œ" ìƒì„± ----------
    async function geminiExplain(point, items, locationSource) {
      // í‚¤ ì—†ìœ¼ë©´ ë°”ë¡œ ì‹¤íŒ¨ ì²˜ë¦¬ â†’ fallback ë¬¸êµ¬ë¡œ
      if (!GEMINI_API_KEY || GEMINI_API_KEY.includes("ì—¬ê¸°ì—_ë„ˆì˜")) {
        throw new Error("GEMINI_API_KEY not set");
      }

      const prompt = `
ë„ˆëŠ” í•œêµ­ì–´ë¡œ ë‹µí•˜ëŠ” ë”°ëœ»í•œ ì±—ë´‡ "ì¶”ì²œí•´ë“œë¦¬ë°"ì´ì•¼.

ì—„ê²©í•œ ê·œì¹™:
- ê³„ì‚°/í•„í„°ë§/ì¶”ê°€ ì¶”ì²œì€ ì ˆëŒ€ í•˜ì§€ ë§ˆ. ì•„ë˜ items(ì´ë¯¸ ì¶”ì²œëœ ëª©ë¡)ë§Œ ì„¤ëª…í•´.
- ì²« ë¬¸ì¥ì— ì‚¬ìš©ìì˜ ë³´ìœ  í¬ì¸íŠ¸(${point})ë¥¼ ë°˜ë“œì‹œ ì–¸ê¸‰í•´.
- ê° itemë§ˆë‹¤ ì¶”ì²œ ì´ìœ ë¥¼ 1~2ë¬¸ì¥ìœ¼ë¡œ ì§§ê²Œ ì¨.
- ë§ˆì§€ë§‰ì— ì„ í˜¸ë¥¼ ë¬»ëŠ” ì§ˆë¬¸ 1ê°œë§Œ í•´.
- ì¶œë ¥ì€ JSONë§Œ. ë‹¤ë¥¸ í…ìŠ¤íŠ¸/ì½”ë“œë¸”ë¡ ê¸ˆì§€.

ì¶œë ¥ JSON í˜•ì‹:
{
  "intro": "string",
  "reasons": [{"id":"string","reason":"string"}],
  "followUp": "string"
}

ì°¸ê³ : locationSource="${locationSource}" (gpsë©´ 'í˜„ì¬ ìœ„ì¹˜ ê¸°ë°˜', fallbackì´ë©´ 'ëŒ€ì „ì»¨ë²¤ì…˜ì„¼í„° ê¸°ì¤€'ì²˜ëŸ¼ ìì—°ìŠ¤ëŸ½ê²Œë§Œ ì–¸ê¸‰ ê°€ëŠ¥)

items:
${JSON.stringify(items.map(it => ({
  id: it.id,
  name: it.name,
  storeName: it.storeName ?? "",
  price: it.price,
  distanceKm: Number(it.distanceKm?.toFixed(2))
})), null, 2)}
      `.trim();

      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${encodeURIComponent(GEMINI_API_KEY)}`;

      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ role: "user", parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.7, maxOutputTokens: 350 }
        })
      });

      if (!res.ok) {
        const t = await res.text();
        throw new Error("Gemini API error: " + t);
      }

      const data = await res.json();
      const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";

      // í˜¹ì‹œ ëª¨ë¸ì´ ë§ ì„ìœ¼ë©´ JSONë§Œ ë½‘ì•„ë‚´ê¸°
      const cleaned = String(text).replace(/```json|```/g, "").trim();
      try {
        return JSON.parse(cleaned);
      } catch {
        const m = cleaned.match(/\{[\s\S]*\}/);
        if (!m) throw new Error("Gemini returned non-JSON");
        return JSON.parse(m[0]);
      }
    }

    // ---------- ì˜µì…˜ ë²„íŠ¼ ----------
    function showOptions(items) {
      document.querySelector(".chat-options")?.remove();
      if (!items.length) return;

      const options = document.createElement("div");
      options.className = "chat-options";

      items.forEach((item) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "chat-option-button";

        const title = document.createElement("div");
        title.className = "chat-option-title";
        title.textContent = `${item.name}`;

        const sub = document.createElement("div");
        sub.className = "chat-option-price";
        const dist = Number(item.distanceKm ?? 0).toFixed(2);
        sub.textContent = `${item.price.toLocaleString()}P Â· ${dist}km`;

        btn.appendChild(title);
        btn.appendChild(sub);

        btn.onclick = () => {
          document.querySelectorAll(".chat-option-button").forEach(el => el.classList.remove("selected"));
          btn.classList.add("selected");
          selectedItem = item;
        };

        options.appendChild(btn);
      });

      chatBody.appendChild(options);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // ---------- ì•¡ì…˜ ë²„íŠ¼ ----------
    function showActions() {
      if (actionsShown) return;
      actionsShown = true;

      const actions = document.createElement("div");
      actions.className = "chat-actions";

      const donateBtn = document.createElement("button");
      donateBtn.className = "chat-action-button";
      donateBtn.textContent = "ê¸°ë¶€í•˜ê¸°";
      donateBtn.onclick = () => {
        if (!selectedItem) {
          alert("ë¨¼ì € ê¸°ë¶€í•  í’ˆëª©ì„ í•˜ë‚˜ ì„ íƒí•´ ì£¼ì„¸ìš”!");
          return;
        }

        localStorage.setItem("donationItem", `${selectedItem.name}`);
        localStorage.setItem("donationAmount", String(selectedItem.price || 0));
        localStorage.setItem("donationItemId", selectedItem.id || "");

        window.location.href = "payment.html";
      };

      const endBtn = document.createElement("button");
      endBtn.className = "chat-action-button chat-action-sub";
      endBtn.textContent = "ì¢…ë£Œí•˜ê¸°";
      endBtn.onclick = () => window.location.href = "home.html";

      actions.appendChild(donateBtn);
      actions.appendChild(endBtn);
      chatBody.appendChild(actions);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // ---------- ì´ˆê¸° ë¡œë”© ----------
    addBubble("ë©”ë‰´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ì—ìš”â€¦", "bot");
    menus = await loadMenusFlexible();

    if (!menus.length) {
      addBubble("Firestoreì—ì„œ menus ë°ì´í„°ë¥¼ ëª» ì°¾ì•˜ì–´ ğŸ˜¢  (collectionGroup('menus') / products í™•ì¸í•´ì¤˜!)", "bot");
      addBubble("âœ… ê·¸ë¦¬ê³  ìœ„ì¹˜ ê¸°ë°˜ì„ ì“°ë ¤ë©´ ê° ë©”ë‰´ ë¬¸ì„œì— lat/lng(ìˆ«ì) í•„ë“œê°€ ìˆì–´ì•¼ í•´!", "bot");
    } else {
      addBubble(`ë©”ë‰´ ${menus.length}ê°œ ë¡œë”© ì™„ë£Œ! ì´ì œ í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•´ì¤˜ ğŸ˜Š`, "bot");
      addBubble("ğŸ“ í¬ì¸íŠ¸ ì…ë ¥í•˜ë©´ ìœ„ì¹˜ ê¶Œí•œì„ ìš”ì²­í•˜ê³ , 1km ë‚´ ë§¤ì¥ë§Œ ì¶”ì²œí• ê²Œìš”!", "bot");
    }

    // ---------- ì…ë ¥ ì²˜ë¦¬ ----------
    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;

      addBubble(text, "user");
      chatInput.value = "";

      if (!menus.length) {
        addBubble("ì•„ì§ ë©”ë‰´ ë°ì´í„°ê°€ ì—†ì–´ì„œ ì¶”ì²œì„ ëª»í•´ìš”. Firestore ë°ì´í„°ë¥¼ ë¨¼ì € í™•ì¸í•´ì¤˜!", "bot");
        return;
      }

      const num = text.match(/\d+/g);
      if (!num) {
        addBubble("ìˆ«ìë¡œ í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•´ì¤˜! ì˜ˆ: 5000", "bot");
        return;
      }

      const point = parseInt(num[0], 10);
      clearOptionsAndActions();

      // 1) ìœ„ì¹˜ ë°›ê¸°
      addBubble("ğŸ“ ìœ„ì¹˜ í™•ì¸ ì¤‘â€¦ (ê¶Œí•œ í—ˆìš©í•˜ë©´ ë” ì •í™•í•´ì ¸ìš”!)", "bot");
      const loc = await getUserLocation();
      const usingFallback = loc.source.startsWith("fallback");

      if (usingFallback) {
        addBubble("ìœ„ì¹˜ ê¶Œí•œì´ ì—†ì–´ì„œ ëŒ€ì „ì»¨ë²¤ì…˜ì„¼í„° ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í• ê²Œìš”!", "bot");
      } else {
        addBubble("í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ 1km ë‚´ì—ì„œ ì¶”ì²œí• ê²Œìš”!", "bot");
      }

      // 2) ìœ„ì¹˜ + í¬ì¸íŠ¸ ê¸°ë°˜ ì¶”ì²œ
      const items = getRecommendedMenus(point, loc.lat, loc.lng);

      if (!items.length) {
        addCardBubble(
          `í˜„ì¬ <b>${point.toLocaleString()}P</b>ë¡œëŠ”<br>` +
          `<b>1km ë‚´</b>ì—ì„œ ê¸°ë¶€ ê°€ëŠ¥í•œ í’ˆëª©ì´ ì—†ì–´ìš” ğŸ˜¢<br>` +
          `í¬ì¸íŠ¸ë¥¼ ë” ëª¨ìœ¼ê±°ë‚˜, ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ë³¼ê¹Œìš”?`
        );
        return;
      }

      // 3) Geminië¡œ â€œì´ìœ /í›„ì† ì§ˆë¬¸â€ ìƒì„±
      addBubble("ğŸ¤– ì œë¯¸ë‚˜ì´ê°€ ì¶”ì²œ ì´ìœ ë¥¼ ë§Œë“¤ê³  ìˆì–´ìš”â€¦", "bot");

      let aiText;
      try {
        aiText = await geminiExplain(point, items, loc.source);
      } catch (err) {
        console.error(err);
        aiText = {
          intro: `${point.toLocaleString()}Pë¡œ ê°€ëŠ¥í•œ ì¶”ì²œì´ì—ìš”!`,
          reasons: items.map(it => ({ id: it.id, reason: "í˜„ì¬ ìœ„ì¹˜ ê·¼ì²˜ì—ì„œ í¬ì¸íŠ¸ ì¡°ê±´ì— ë§ëŠ” ë©”ë‰´ë¼ ì¶”ì²œí•´ìš”!" })),
          followUp: "ì»¤í”¼/ë””ì €íŠ¸/í¸ì˜ì  ì¤‘ ì–´ë–¤ ìª½ì´ ë” ëŒë ¤ìš”?"
        };
        addBubble("âš ï¸ ì œë¯¸ë‚˜ì´ í˜¸ì¶œì´ ì‹¤íŒ¨í•´ì„œ ê¸°ë³¸ ë¬¸êµ¬ë¡œ ë³´ì—¬ì¤„ê²Œìš” (API í‚¤/ì¿¼í„° í™•ì¸ í•„ìš”)", "bot");
      }

      const reasonMap = new Map((aiText.reasons || []).map(r => [r.id, r.reason]));

      const listHtml = items.map((it, idx) => {
        const reason = reasonMap.get(it.id) || "í¬ì¸íŠ¸ ì¡°ê±´ê³¼ ê±°ë¦¬ ì¡°ê±´ì— ë§ëŠ” ë©”ë‰´ë¼ ì¶”ì²œí•´ìš”!";
        const dist = Number(it.distanceKm ?? 0).toFixed(2);
        const store = it.storeName ? ` Â· ${it.storeName}` : "";
        return `${idx + 1}. <b>${it.name}</b> (${it.price.toLocaleString()}P Â· ${dist}km${store})<br><span style="opacity:.9">${reason}</span>`;
      }).join("<br><br>");

      const intro = aiText.intro || `${point.toLocaleString()}Pë¡œ ê°€ëŠ¥í•œ ì¶”ì²œì´ì—ìš”!`;
      const followUp = aiText.followUp || "ì–´ë–¤ ë©”ë‰´ê°€ ë” ëŒë ¤ìš”?";

      addCardBubble(`
        <b>${intro}</b><br><br>
        ${listHtml}<br><br>
        <b>Q.</b> ${followUp}
      `);

      showOptions(items);
      showActions();
    });

  </script>
</body>
</html>
