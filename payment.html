<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>사줄게요 - 결제</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="screen payment-screen">
    <!-- 상단 헤더 -->
    <header class="payment-header">
      <a href="recommend.html" class="back">‹</a>
      <h1 class="payment-title">사줄게요</h1>
    </header>

    <!-- 본문 -->
    <main class="payment-body">
      <!-- 기부 요약 카드 -->
      <section class="pay-card order-card">
        <div class="card-title">기부 요약</div>

        <div class="order-row">
          <span class="order-label">기부 품목</span>
          <!-- 👉 여기로 선택한 품목 이름이 들어옴 -->
          <span class="order-value" id="pay-item">선택한 품목</span>
        </div>

        <div class="order-row order-total">
          <span class="order-label">기부 예정 금액</span>
          <!-- 👉 여기로 선택한 금액이 들어옴 -->
          <span class="order-total-value" id="pay-total">0원</span>
        </div>
      </section>

      <!-- 코레일 마일리지 카드 -->
      <section class="pay-card mileage-card">
        <div class="order-row">
          <span class="order-label">코레일 마일리지</span>
          <span class="mileage-value" id="pay-mileage">0P</span>
        </div>
        <button type="button" class="mileage-detail-row">
          <span>적립 내역 보기</span>
          <span>›</span>
        </button>
      </section>

      <!-- 결제 수단 카드 -->
      <section class="pay-card method-card">
        <div class="card-title">결제 수단</div>

        <div class="pay-method-list" id="pay-method-list">
          <!-- 신용카드 -->
          <button type="button" class="pay-method-option selected" data-method="신용카드">
            <div class="pay-method-main">
              <div class="pay-method-icon">💳</div>
              <div class="pay-method-text">
                <div class="pay-method-name">신용카드</div>
                <div class="pay-method-sub">일시불 / 할부 결제</div>
              </div>
            </div>
            <div class="pay-method-check">✔</div>
          </button>

          <!-- 카카오페이 -->
          <button type="button" class="pay-method-option" data-method="카카오페이">
            <div class="pay-method-main">
              <div class="pay-method-icon">🟡</div>
              <div class="pay-method-text">
                <div class="pay-method-name">카카오페이</div>
                <div class="pay-method-sub">카카오톡 간편결제</div>
              </div>
            </div>
          </button>

          <!-- 네이버페이 -->
          <button type="button" class="pay-method-option" data-method="네이버페이">
            <div class="pay-method-main">
              <div class="pay-method-icon">🟢</div>
              <div class="pay-method-text">
                <div class="pay-method-name">네이버페이</div>
                <div class="pay-method-sub">포인트 적립 가능</div>
              </div>
            </div>
          </button>

          <!-- 토스페이 -->
          <button type="button" class="pay-method-option" data-method="토스페이">
            <div class="pay-method-main">
              <div class="pay-method-icon">💙</div>
              <div class="pay-method-text">
                <div class="pay-method-name">토스페이</div>
                <div class="pay-method-sub">간편 송금 결제</div>
              </div>
            </div>
          </button>

          <!-- 마일리지 사용 -->
          <div class="pay-mileage-use">
            <div class="pay-mileage-use-header">
              <span class="pay-method-name">마일리지 사용</span>
            </div>
            <div class="pay-mileage-use-body">
              <div class="pay-mileage-input-row">
                <span class="pay-mileage-label">마일리지</span>
                <input
                  type="number"
                  id="mileage-input"
                  class="pay-mileage-input"
                  min="0"
                  value="0"
                />
                <span class="pay-mileage-unit">P</span>
                <button type="button" class="pay-mileage-all" id="mileage-all">
                  모두 사용
                </button>
              </div>
              <div class="pay-mileage-bar">
                <div class="pay-mileage-bar-fill" id="mileage-bar-fill"></div>
              </div>
            </div>
          </div>
        </div>
        <!-- ✅ 토스 결제위젯이 렌더링될 자리 -->
<div id="toss-payment-methods" style="display:none; margin-top: 12px;"></div>
<div id="toss-agreement" style="display:none; margin-top: 10px;"></div>

      </section>

      <!-- 응원 메시지 카드 -->
      <section class="pay-card message-card">
        <div class="card-title">응원 메시지 (선택)</div>
        <textarea
          class="message-textarea"
          id="support-message"
          placeholder="따뜻한 응원 메세지를 남겨주세요"
        ></textarea>
      </section>
    </main>

    <!-- 하단 결제 버튼 -->
    <button class="payment-submit-button" id="payment-submit">
      <span id="payment-submit-label">0원 결제</span>
    </button>
  </div>

  <script>
    // --- 1. 추천해드리밍에서 넘어온 데이터 읽기 ---
    const storedItem   = localStorage.getItem("donationItem")   || "선택한 품목 없음";
    const storedAmount = localStorage.getItem("donationAmount") || "0";
    const amount = parseInt(storedAmount, 10) || 0;

    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    const payItemEl       = document.getElementById("pay-item");
    const payTotalEl      = document.getElementById("pay-total");
    const payMileageEl    = document.getElementById("pay-mileage");
    const payButtonLabel  = document.getElementById("payment-submit-label");
    const mileageInput    = document.getElementById("mileage-input");
    const mileageAllBtn   = document.getElementById("mileage-all");
    const mileageBarFill  = document.getElementById("mileage-bar-fill");

    // 화면에 값 반영
    payItemEl.textContent    = storedItem;
    payTotalEl.textContent   = formatNumber(amount) + "원";
    payMileageEl.textContent = formatNumber(amount) + "P";
    payButtonLabel.textContent = formatNumber(amount) + "원 결제";
    mileageInput.max = amount;
    mileageInput.value = 0;
    mileageBarFill.style.width = "0%";

    function updateMileageBar() {
      const used = parseInt(mileageInput.value || "0", 10);
      const ratio = amount > 0 ? Math.min(used / amount, 1) : 0;
      mileageBarFill.style.width = ratio * 100 + "%";
    }

    mileageInput.addEventListener("input", () => {
      if (parseInt(mileageInput.value || "0", 10) > amount) {
        mileageInput.value = amount;
      }
      updateMileageBar();
    });

    mileageAllBtn.addEventListener("click", () => {
      mileageInput.value = amount;
      updateMileageBar();
    });

    // --- 2. 결제 수단 선택 ---
    const methodList = document.getElementById("pay-method-list");
    let selectedMethod = "신용카드";

    methodList.addEventListener("click", (e) => {
      const option = e.target.closest(".pay-method-option");
      if (!option) return;

      document
        .querySelectorAll(".pay-method-option")
        .forEach((el) => el.classList.remove("selected"));

      option.classList.add("selected");
      selectedMethod = option.dataset.method || "신용카드";
    });

    // --- 3. 결제 버튼 (데모용) ---
    const submitBtn = document.getElementById("payment-submit");

    submitBtn.addEventListener("click", () => {
      const usedMileage = parseInt(mileageInput.value || "0", 10);
      const finalAmount = Math.max(amount - usedMileage, 0);

        <!-- ✅ 토스 결제위젯 SDK는 script 안이 아니라, 이렇게 따로! -->
  <script src="https://js.tosspayments.com/v2/standard"></script>

  <script>
    // --- 1. 추천해드리밍에서 넘어온 데이터 읽기 ---
    const storedItem   = localStorage.getItem("donationItem")   || "선택한 품목 없음";
    const storedAmount = localStorage.getItem("donationAmount") || "0";
    const amount = parseInt(storedAmount, 10) || 0;

    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    const payItemEl       = document.getElementById("pay-item");
    const payTotalEl      = document.getElementById("pay-total");
    const payMileageEl    = document.getElementById("pay-mileage");
    const payButtonLabel  = document.getElementById("payment-submit-label");
    const mileageInput    = document.getElementById("mileage-input");
    const mileageAllBtn   = document.getElementById("mileage-all");
    const mileageBarFill  = document.getElementById("mileage-bar-fill");

    // 화면에 값 반영
    payItemEl.textContent    = storedItem;
    payTotalEl.textContent   = formatNumber(amount) + "원";
    payMileageEl.textContent = formatNumber(amount) + "P";
    payButtonLabel.textContent = formatNumber(amount) + "원 결제";

    mileageInput.max = amount;
    mileageInput.value = 0;
    mileageBarFill.style.width = "0%";

    function getUsedMileage() {
      return parseInt(mileageInput.value || "0", 10) || 0;
    }

    function getFinalAmount() {
      return Math.max(amount - getUsedMileage(), 0);
    }

    function updateMileageBar() {
      const used = getUsedMileage();
      const ratio = amount > 0 ? Math.min(used / amount, 1) : 0;
      mileageBarFill.style.width = ratio * 100 + "%";
      payButtonLabel.textContent = formatNumber(getFinalAmount()) + "원 결제";
    }

    mileageInput.addEventListener("input", () => {
      if (getUsedMileage() > amount) mileageInput.value = amount;
      updateMileageBar();
    });

    mileageAllBtn.addEventListener("click", () => {
      mileageInput.value = amount;
      updateMileageBar();
    });

    // --- 2. 결제 수단 선택 ---
    const methodList = document.getElementById("pay-method-list");
    let selectedMethod = "신용카드";

    methodList.addEventListener("click", (e) => {
      const option = e.target.closest(".pay-method-option");
      if (!option) return;

      document.querySelectorAll(".pay-method-option").forEach((el) => {
        el.classList.remove("selected");
        const check = el.querySelector(".pay-method-check");
        if (check) check.remove();
      });

      option.classList.add("selected");
      selectedMethod = option.dataset.method || "신용카드";

      // 체크 표시(✔)를 선택된 것만 보이게(카드처럼)
      if (!option.querySelector(".pay-method-check")) {
        const check = document.createElement("div");
        check.className = "pay-method-check";
        check.textContent = "✔";
        option.appendChild(check);
      }
    });

    // --- 3. 결제 버튼: 결제 진행 중 화면으로 이동 ---
    const submitBtn = document.getElementById("payment-submit");

    submitBtn.addEventListener("click", () => {
      const finalAmount = getFinalAmount();

      if (finalAmount <= 0) {
        alert("결제 금액이 0원입니다.");
        return;
      }

      // 결제 정보 저장(다음 화면에서 읽기)
      localStorage.setItem("pay_item", storedItem);
      localStorage.setItem("pay_method", selectedMethod);
      localStorage.setItem("pay_amount", finalAmount.toString());

      // 결제 진행 중 화면으로 이동
      window.location.href = "payment_loading.html";
    });
  </script>
</body>
</html>
