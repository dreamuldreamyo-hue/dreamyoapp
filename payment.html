<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‚¬ì¤„ê²Œìš” - ê²°ì œ</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="screen payment-screen">
    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="payment-header">
      <a href="recommend.html" class="back">â€¹</a>
      <h1 class="payment-title">ì‚¬ì¤„ê²Œìš”</h1>
    </header>

    <!-- ë³¸ë¬¸ -->
    <main class="payment-body">
      <!-- ê¸°ë¶€ ìš”ì•½ ì¹´ë“œ -->
      <section class="pay-card order-card">
        <div class="card-title">ê¸°ë¶€ ìš”ì•½</div>

        <div class="order-row">
          <span class="order-label">ê¸°ë¶€ í’ˆëª©</span>
          <!-- ğŸ‘‰ ì—¬ê¸°ë¡œ ì„ íƒí•œ í’ˆëª© ì´ë¦„ì´ ë“¤ì–´ì˜´ -->
          <span class="order-value" id="pay-item">ì„ íƒí•œ í’ˆëª©</span>
        </div>

        <div class="order-row order-total">
          <span class="order-label">ê¸°ë¶€ ì˜ˆì • ê¸ˆì•¡</span>
          <!-- ğŸ‘‰ ì—¬ê¸°ë¡œ ì„ íƒí•œ ê¸ˆì•¡ì´ ë“¤ì–´ì˜´ -->
          <span class="order-total-value" id="pay-total">0ì›</span>
        </div>
      </section>

      <!-- ì½”ë ˆì¼ ë§ˆì¼ë¦¬ì§€ ì¹´ë“œ -->
      <section class="pay-card mileage-card">
        <div class="order-row">
          <span class="order-label">ì½”ë ˆì¼ ë§ˆì¼ë¦¬ì§€</span>
          <span class="mileage-value" id="pay-mileage">0P</span>
        </div>
        <button type="button" class="mileage-detail-row">
          <span>ì ë¦½ ë‚´ì—­ ë³´ê¸°</span>
          <span>â€º</span>
        </button>
      </section>

      <!-- ê²°ì œ ìˆ˜ë‹¨ ì¹´ë“œ -->
      <section class="pay-card method-card">
        <div class="card-title">ê²°ì œ ìˆ˜ë‹¨</div>

        <div class="pay-method-list" id="pay-method-list">
          <!-- ì‹ ìš©ì¹´ë“œ -->
          <button type="button" class="pay-method-option selected" data-method="ì‹ ìš©ì¹´ë“œ">
            <div class="pay-method-main">
              <div class="pay-method-icon">ğŸ’³</div>
              <div class="pay-method-text">
                <div class="pay-method-name">ì‹ ìš©ì¹´ë“œ</div>
                <div class="pay-method-sub">ì¼ì‹œë¶ˆ / í• ë¶€ ê²°ì œ</div>
              </div>
            </div>
            <div class="pay-method-check">âœ”</div>
          </button>

          <!-- ì¹´ì¹´ì˜¤í˜ì´ -->
          <button type="button" class="pay-method-option" data-method="ì¹´ì¹´ì˜¤í˜ì´">
            <div class="pay-method-main">
              <div class="pay-method-icon">ğŸŸ¡</div>
              <div class="pay-method-text">
                <div class="pay-method-name">ì¹´ì¹´ì˜¤í˜ì´</div>
                <div class="pay-method-sub">ì¹´ì¹´ì˜¤í†¡ ê°„í¸ê²°ì œ</div>
              </div>
            </div>
          </button>

          <!-- ë„¤ì´ë²„í˜ì´ -->
          <button type="button" class="pay-method-option" data-method="ë„¤ì´ë²„í˜ì´">
            <div class="pay-method-main">
              <div class="pay-method-icon">ğŸŸ¢</div>
              <div class="pay-method-text">
                <div class="pay-method-name">ë„¤ì´ë²„í˜ì´</div>
                <div class="pay-method-sub">í¬ì¸íŠ¸ ì ë¦½ ê°€ëŠ¥</div>
              </div>
            </div>
          </button>

          <!-- í† ìŠ¤í˜ì´ -->
          <button type="button" class="pay-method-option" data-method="í† ìŠ¤í˜ì´">
            <div class="pay-method-main">
              <div class="pay-method-icon">ğŸ’™</div>
              <div class="pay-method-text">
                <div class="pay-method-name">í† ìŠ¤í˜ì´</div>
                <div class="pay-method-sub">ê°„í¸ ì†¡ê¸ˆ ê²°ì œ</div>
              </div>
            </div>
          </button>

          <!-- ë§ˆì¼ë¦¬ì§€ ì‚¬ìš© -->
          <div class="pay-mileage-use">
            <div class="pay-mileage-use-header">
              <span class="pay-method-name">ë§ˆì¼ë¦¬ì§€ ì‚¬ìš©</span>
            </div>
            <div class="pay-mileage-use-body">
              <div class="pay-mileage-input-row">
                <span class="pay-mileage-label">ë§ˆì¼ë¦¬ì§€</span>
                <input
                  type="number"
                  id="mileage-input"
                  class="pay-mileage-input"
                  min="0"
                  value="0"
                />
                <span class="pay-mileage-unit">P</span>
                <button type="button" class="pay-mileage-all" id="mileage-all">
                  ëª¨ë‘ ì‚¬ìš©
                </button>
              </div>
              <div class="pay-mileage-bar">
                <div class="pay-mileage-bar-fill" id="mileage-bar-fill"></div>
              </div>
            </div>
          </div>
        </div>
        <!-- âœ… í† ìŠ¤ ê²°ì œìœ„ì ¯ì´ ë Œë”ë§ë  ìë¦¬ -->
<div id="toss-payment-methods" style="display:none; margin-top: 12px;"></div>
<div id="toss-agreement" style="display:none; margin-top: 10px;"></div>

      </section>

      <!-- ì‘ì› ë©”ì‹œì§€ ì¹´ë“œ -->
      <section class="pay-card message-card">
        <div class="card-title">ì‘ì› ë©”ì‹œì§€ (ì„ íƒ)</div>
        <textarea
          class="message-textarea"
          id="support-message"
          placeholder="ë”°ëœ»í•œ ì‘ì› ë©”ì„¸ì§€ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”"
        ></textarea>
      </section>
    </main>

    <!-- í•˜ë‹¨ ê²°ì œ ë²„íŠ¼ -->
    <button class="payment-submit-button" id="payment-submit">
      <span id="payment-submit-label">0ì› ê²°ì œ</span>
    </button>
  </div>

  <script>
    // --- 1. ì¶”ì²œí•´ë“œë¦¬ë°ì—ì„œ ë„˜ì–´ì˜¨ ë°ì´í„° ì½ê¸° ---
    const storedItem   = localStorage.getItem("donationItem")   || "ì„ íƒí•œ í’ˆëª© ì—†ìŒ";
    const storedAmount = localStorage.getItem("donationAmount") || "0";
    const amount = parseInt(storedAmount, 10) || 0;

    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    const payItemEl       = document.getElementById("pay-item");
    const payTotalEl      = document.getElementById("pay-total");
    const payMileageEl    = document.getElementById("pay-mileage");
    const payButtonLabel  = document.getElementById("payment-submit-label");
    const mileageInput    = document.getElementById("mileage-input");
    const mileageAllBtn   = document.getElementById("mileage-all");
    const mileageBarFill  = document.getElementById("mileage-bar-fill");

    // í™”ë©´ì— ê°’ ë°˜ì˜
    payItemEl.textContent    = storedItem;
    payTotalEl.textContent   = formatNumber(amount) + "ì›";
    payMileageEl.textContent = formatNumber(amount) + "P";
    payButtonLabel.textContent = formatNumber(amount) + "ì› ê²°ì œ";
    mileageInput.max = amount;
    mileageInput.value = 0;
    mileageBarFill.style.width = "0%";

    function updateMileageBar() {
      const used = parseInt(mileageInput.value || "0", 10);
      const ratio = amount > 0 ? Math.min(used / amount, 1) : 0;
      mileageBarFill.style.width = ratio * 100 + "%";
    }

    mileageInput.addEventListener("input", () => {
      if (parseInt(mileageInput.value || "0", 10) > amount) {
        mileageInput.value = amount;
      }
      updateMileageBar();
    });

    mileageAllBtn.addEventListener("click", () => {
      mileageInput.value = amount;
      updateMileageBar();
    });

    // --- 2. ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ ---
    const methodList = document.getElementById("pay-method-list");
    let selectedMethod = "ì‹ ìš©ì¹´ë“œ";

    methodList.addEventListener("click", (e) => {
      const option = e.target.closest(".pay-method-option");
      if (!option) return;

      document
        .querySelectorAll(".pay-method-option")
        .forEach((el) => el.classList.remove("selected"));

      option.classList.add("selected");
      selectedMethod = option.dataset.method || "ì‹ ìš©ì¹´ë“œ";
    });

    // --- 3. ê²°ì œ ë²„íŠ¼ (ë°ëª¨ìš©) ---
    const submitBtn = document.getElementById("payment-submit");

    submitBtn.addEventListener("click", () => {
      const usedMileage = parseInt(mileageInput.value || "0", 10);
      const finalAmount = Math.max(amount - usedMileage, 0);

        <!-- âœ… í† ìŠ¤ ê²°ì œìœ„ì ¯ SDKëŠ” script ì•ˆì´ ì•„ë‹ˆë¼, ì´ë ‡ê²Œ ë”°ë¡œ! -->
  <script src="https://js.tosspayments.com/v2/standard"></script>

  <script>
    // --- 1. ì¶”ì²œí•´ë“œë¦¬ë°ì—ì„œ ë„˜ì–´ì˜¨ ë°ì´í„° ì½ê¸° ---
    const storedItem   = localStorage.getItem("donationItem")   || "ì„ íƒí•œ í’ˆëª© ì—†ìŒ";
    const storedAmount = localStorage.getItem("donationAmount") || "0";
    const amount = parseInt(storedAmount, 10) || 0;

    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    const payItemEl       = document.getElementById("pay-item");
    const payTotalEl      = document.getElementById("pay-total");
    const payMileageEl    = document.getElementById("pay-mileage");
    const payButtonLabel  = document.getElementById("payment-submit-label");
    const mileageInput    = document.getElementById("mileage-input");
    const mileageAllBtn   = document.getElementById("mileage-all");
    const mileageBarFill  = document.getElementById("mileage-bar-fill");

    // í™”ë©´ì— ê°’ ë°˜ì˜
    payItemEl.textContent    = storedItem;
    payTotalEl.textContent   = formatNumber(amount) + "ì›";
    payMileageEl.textContent = formatNumber(amount) + "P";
    payButtonLabel.textContent = formatNumber(amount) + "ì› ê²°ì œ";

    mileageInput.max = amount;
    mileageInput.value = 0;
    mileageBarFill.style.width = "0%";

    function getUsedMileage() {
      return parseInt(mileageInput.value || "0", 10) || 0;
    }

    function getFinalAmount() {
      return Math.max(amount - getUsedMileage(), 0);
    }

    function updateMileageBar() {
      const used = getUsedMileage();
      const ratio = amount > 0 ? Math.min(used / amount, 1) : 0;
      mileageBarFill.style.width = ratio * 100 + "%";
      payButtonLabel.textContent = formatNumber(getFinalAmount()) + "ì› ê²°ì œ";
    }

    mileageInput.addEventListener("input", () => {
      if (getUsedMileage() > amount) mileageInput.value = amount;
      updateMileageBar();
    });

    mileageAllBtn.addEventListener("click", () => {
      mileageInput.value = amount;
      updateMileageBar();
    });

    // --- 2. ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ ---
    const methodList = document.getElementById("pay-method-list");
    let selectedMethod = "ì‹ ìš©ì¹´ë“œ";

    methodList.addEventListener("click", (e) => {
      const option = e.target.closest(".pay-method-option");
      if (!option) return;

      document.querySelectorAll(".pay-method-option").forEach((el) => {
        el.classList.remove("selected");
        const check = el.querySelector(".pay-method-check");
        if (check) check.remove();
      });

      option.classList.add("selected");
      selectedMethod = option.dataset.method || "ì‹ ìš©ì¹´ë“œ";

      // ì²´í¬ í‘œì‹œ(âœ”)ë¥¼ ì„ íƒëœ ê²ƒë§Œ ë³´ì´ê²Œ(ì¹´ë“œì²˜ëŸ¼)
      if (!option.querySelector(".pay-method-check")) {
        const check = document.createElement("div");
        check.className = "pay-method-check";
        check.textContent = "âœ”";
        option.appendChild(check);
      }
    });

    // --- 3. ê²°ì œ ë²„íŠ¼: ê²°ì œ ì§„í–‰ ì¤‘ í™”ë©´ìœ¼ë¡œ ì´ë™ ---
    const submitBtn = document.getElementById("payment-submit");

    submitBtn.addEventListener("click", () => {
      const finalAmount = getFinalAmount();

      if (finalAmount <= 0) {
        alert("ê²°ì œ ê¸ˆì•¡ì´ 0ì›ì…ë‹ˆë‹¤.");
        return;
      }

      // ê²°ì œ ì •ë³´ ì €ì¥(ë‹¤ìŒ í™”ë©´ì—ì„œ ì½ê¸°)
      localStorage.setItem("pay_item", storedItem);
      localStorage.setItem("pay_method", selectedMethod);
      localStorage.setItem("pay_amount", finalAmount.toString());

      // ê²°ì œ ì§„í–‰ ì¤‘ í™”ë©´ìœ¼ë¡œ ì´ë™
      window.location.href = "payment_loading.html";
    });
  </script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "ë„¤_API_KEY",
    authDomain: "dreamyo-e42bb.firebaseapp.com",
    projectId: "dreamyo-e42bb",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.saveDonation = async function ({ item, amount, method }) {
    await addDoc(collection(db, "donations"), {
      userId: "testUser", // ì§€ê¸ˆì€ ë°ëª¨
      item,
      amount,
      method,
      createdAt: serverTimestamp(),
    });
  };
</script>

</body>
</html>
